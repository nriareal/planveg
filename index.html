<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegan Meal Prep Planner</title>
    <!-- The <style> block has been removed and replaced with this link to your external stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dark-mode-toggle" id="darkModeToggle">
        <span id="darkModeIcon">üåô</span>
    </div>

    <div id="pdf-render-area" style="position: absolute; left: -9999px; top: 0; background: white;"></div>

    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 16.67%"></div>
        </div>

        <div class="summary-card hidden" id="summaryCard">
            </div>

        <div class="step active" id="step1">
            <div class="card">
                <h1>üå± Vegan Meal Prep Planner</h1>
                <p style="text-align: center; margin-bottom: 25px; color: #718096; font-size: 1.1em;">
                    Let‚Äôs get started! We‚Äôll use your details to craft a fully personalized vegan plan.
                </p>
                <h2><span style="margin-right: 10px;">üë§</span> Personal Details</h2>
                <div id="step1-error-message" class="warning hidden"></div>
                
                <div class="disclaimer">
                    <strong>Disclaimer:</strong> This website provides meal plan estimations based on general nutritional science. These calculations are for informational purposes only and are not a substitute for professional medical or dietary advice. Individual results may vary. Consult with a healthcare professional or registered dietitian before making any significant changes to your diet or lifestyle.
                </div>

                <div class="form-group">
                    <label for="planName">Your Plan Name (Optional)</label>
                    <input type="text" id="planName" placeholder="e.g. My Vegan Journey">
                </div>

                <div class="form-group">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" step="0.1" required>
                </div>

                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" required>
                </div>

                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non_binary">Non-binary</option>
                        <option value="trans_male">Trans male</option>
                        <option value="trans_female">Trans female</option>
                        <option value="prefer_not_to_say">Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" min="15" max="100" value="25" required>
                </div>

                <div class="form-group">
                    <label for="activityLevel">Activity Level</label>
                    <select id="activityLevel">
                        <option value="sedentary">Sedentary (little or no exercise)</option>
                        <option value="lightly_active">Lightly Active (light exercise/sports 1-3 days/week)</option>
                        <option value="moderately_active">Moderately Active (moderate exercise/sports 3-5 days/week)</option>
                        <option value="very_active">Very Active (hard exercise/sports 6-7 days a week)</option>
                        <option value="extremely_active">Extremely Active (hard daily exercise/sports & physical job or 2x training)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bodyType">Body Type (for estimation if not provided)</label>
                    <select id="bodyType">
                        <option value="average">Average/Mesomorph</option>
                        <option value="lean">Lean/Ectomorph</option>
                        <option value="stocky">Stocky/Endomorph</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bodyFat" title="Your Body Fat Percentage. This helps fine-tune calorie needs.">Body Fat Percentage (%) <span style="font-size: 0.8em; color: #718096;">(Optional)</span></label>
                    <input type="range" id="bodyFat" min="5" max="50" value="20" oninput="document.getElementById('bodyFatValue').innerText = this.value + '%'">
                    <span class="range-value" id="bodyFatValue">20%</span>
                </div>

                <div class="form-group">
                    <label for="muscleMass" title="Your Muscle Mass in kilograms. Used for more accurate BMR calculations.">Muscle Mass (kg) <span style="font-size: 0.8em; color: #718096;">(Optional)</span></label>
                    <input type="number" id="muscleMass" step="0.1" placeholder="e.g. 45 (estimated if blank)">
                </div>

                <div class="form-group">
                    <label for="dailyCaloriesBurned" title="Your estimated total daily calorie expenditure.">Total Daily Calories Burned <span style="font-size: 0.8em; color: #718096;">(Optional)</span></label>
                    <input type="range" id="dailyCaloriesBurned" min="1000" max="4000" value="2000" step="50" oninput="document.getElementById('dailyCaloriesBurnedValue').innerText = this.value + ' kcal'">
                    <span class="range-value" id="dailyCaloriesBurnedValue">2000 kcal</span>
                </div>

                <div class="button-group">
                    <button class="btn" id="nextBtnStep1">Next</button>
                    <button class="btn btn-secondary" onclick="openInfoModal()">Learn More about Calculations</button>
                    <button class="btn btn-secondary" onclick="openAdvantagesModal()">Advantages of a Vegan Diet</button>
                </div>
            </div>
        </div>

        <div class="step" id="step2">
            <div class="card">
                <h2><span style="margin-right: 10px;">üéØ</span> Your Goals</h2>
                <div id="step2-error-message" class="warning hidden"></div>
                
                <div class="form-group">
                    <label for="goal">Primary Goal</label>
                    <select id="goal" onchange="toggleWeightLossRate()">
                        <option value="maintain">Maintain Weight</option>
                        <option value="lose">Lose Fat</option>
                        <option value="gain">Gain Muscle</option>
                        <option value="recomp">Recomposition (Gain Muscle + Lose Fat)</option>
                        <option value="gain_weight">Gain Weight (Low BMI)</option>
                    </select>
                </div>

                <div class="form-group hidden" id="weightLossGroup">
                    <label for="weightLossRate">Weight Loss Rate</label>
                    <select id="weightLossRate">
                        <option value="0.5">0.5 kg/week</option>
                        <option value="1">1 kg/week</option>
                        <option value="1.5" id="aggressiveOption">1.5 kg/week</option>
                    </select>
                    <div class="warning hidden" id="aggressiveWarning">
                        1.5 kg/week option is only available for body fat percentages above 35%
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn" id="prevBtnStep2">Previous</button>
	                <button class="btn" id="nextBtnStep2">Next</button>
                </div>
            </div>
        </div>

        <div class="step" id="step3">
            <div class="card">
                <h2><span style="margin-right: 10px;">üçΩÔ∏è</span> Food Preferences & Allergies</h2>
                <div id="step3-error-message" class="warning hidden"></div>
                <p style="margin-bottom: 20px; color: #718096;">Select any foods you'd like to exclude from your meal plan:</p>
                
                <div class="checkbox-group" id="foodExclusions">
                    <div class="checkbox-item">
                        <input type="checkbox" id="gluten" value="gluten">
                        <label for="gluten">Gluten</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="nuts" value="nuts">
                        <label for="nuts">Tree Nuts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="peanuts" value="peanuts">
                        <label for="peanuts">Peanuts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="soy" value="soy">
                        <label for="soy">Soy</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="seeds" value="seeds">
                        <label for="seeds">Seeds</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coconut" value="coconut">
                        <label for="coconut">Coconut</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mushrooms" value="mushrooms">
                        <label for="mushrooms">Mushrooms</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="legumes" value="legumes">
                        <label for="legumes">Legumes</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="milkPreference">Preferred Plant Milk Type</label>
                    <select id="milkPreference">
                        <option value="any">Any / No Preference</option>
                        <option value="almond">Almond Milk</option>
                        <option value="soy">Soy Milk</option>
                        <option value="oat">Oat Milk</option>
                        <option value="coconut">Coconut Milk</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn" id="prevBtnStep3">Previous</button>
                    <button class="btn" id="calculatePlanBtn" onclick="calculateNutrition()">Calculate Plan</button>
                </div>
            </div>
        </div>

        <div class="step" id="step4">
            <div class="card">
                <h2><span style="margin-right: 10px;">üìä</span> Your Nutritional Plan</h2>
                <div id="step4-error-message" class="warning hidden"></div>
                
                <div class="nutrition-summary" id="nutritionSummary">
                    </div>

                <div class="button-group">
                    <button class="btn" id="prevBtnStep4">Previous</button>
                    <button class="btn" id="continueToMealPreferencesBtn" onclick="nextStep()">Continue to Meal Preferences</button>
                </div>
            </div>
        </div>

        <div class="step" id="step5">
            <div class="card">
                <h2><span style="margin-right: 10px;">üìÖ</span> Meal Preferences</h2>
                <div id="step5-error-message" class="warning hidden"></div>
                
                <div class="form-group">
                    <label for="cookingFreq">Cooking Frequency Preference</label>
                    <select id="cookingFreq">
                        <option value="batch">Batch cooking (cook once, eat multiple times)</option>
                        <option value="fresh">Fresh cooking (different meals each time)</option>
                        <option value="mixed">Mixed approach</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="variety">Desired Meal Variety</label>
                    <select id="variety">
                        <option value="low">Low (simple, repeated meals)</option>
                        <option value="medium">Medium (some variety)</option>
                        <option value="high">High (maximum variety)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="numWeeks">Number of Weeks for Meal Plan</label>
                    <select id="numWeeks">
                        <option value="1">1 Week</option>
                        <option value="2">2 Weeks</option>
                        <option value="3">3 Weeks</option>
                        <option value="4">4 Weeks</option>
                    </select>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="substitutePreference">Include Ready-to-Go Vegan Substitutes?</label>
                    <select id="substitutePreference">
                        <option value="none">None (prefer whole foods)</option>
                        <option value="some">Some (generic vegan patties, sausages)</option>
                        <option value="all">All (includes branded like Beyond, Impossible)</option>
                    </select>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label>Cuisine Preferences (select any you like, or leave blank for all)</label>
                    <div class="checkbox-group" id="cuisinePreferences">
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_east_asian" value="East Asian">
                            <label for="cuisine_east_asian">East Asian (e.g., Japanese, Chinese)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_south_asian" value="South Asian">
                            <label for="cuisine_south_asian">South Asian (e.g., Indian)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_southeast_asian" value="Southeast Asian">
                            <label for="cuisine_southeast_asian">Southeast Asian (e.g., Thai, Vietnamese)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_latin_american" value="Latin American">
                            <label for="cuisine_latin_american">Latin American (e.g., Mexican)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_mediterranean" value="Mediterranean">
                            <label for="cuisine_mediterranean">Mediterranean (e.g., Greek, Italian)</label>
                        </div>
                         <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_middle_eastern" value="Middle Eastern">
                            <label for="cuisine_middle_eastern">Middle Eastern (e.g., Lebanese)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_african" value="African">
                            <label for="cuisine_african">African</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cuisine_western" value="Western">
                            <label for="cuisine_western">Western (e.g., American, European)</label>
                        </div>
                    </div>
                </div>


                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep5" onclick="prevStep()">Back</button>
                    <button class="btn" id="reviewMealsBtn" onclick="prepareMealReview()">Review & Refine Meals</button>
                </div>
            </div>
        </div>

        <div class="step" id="step6">
            <div class="card">
                <h2><span style="margin-right: 10px;">üîç</span> Review & Exclude Meals</h2>
                <div id="step6-error-message" class="warning hidden"></div>
                <p style="text-align: center; margin-bottom: 25px; color: #718096; font-size: 1.1em;">
                    Uncheck any meals you don't want in your plan. We'll replace them with other options.
                </p>
                <div id="mealReviewSection" class="meal-review-container">
                    </div>
                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep6" onclick="prevStep()">Back to Preferences</button>
                    <button class="btn" id="generatePlanBtn" onclick="generateMealPlan()">Generate My Meal Plan</button>
                </div>
            </div>
        </div>


        <div class="step" id="loading">
            <div class="card">
                <div class="loading">
                    <div class="spinner"></div>
                    <h2>Generating Your Personalized Meal Plan...</h2>
                    <p>Creating nutritionally balanced vegan meals just for you!</p>
                </div>
            </div>
        </div>

        <div class="step" id="step7">
            <div class="card">
                <h2><span style="margin-right: 10px;">‚úÖ</span> Your 7-Day Vegan Meal Plan</h2>
                <div id="step7-error-message" class="warning hidden"></div>
                
                <div id="mealPlanResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep7" onclick="prevStep()">Back</button>
                    <button class="btn" id="viewShoppingListBtn" onclick="showShoppingList()">View Shopping List</button>
                    <button class="btn" id="downloadPlanBtn" onclick="downloadPlan()">Download PDF</button>
                </div>
            </div>
        </div>

        <div class="step" id="step8">
            <div class="card">
                <h2><span style="margin-right: 10px;">üõí</span> Shopping List</h2>
                <div id="step8-error-message" class="warning hidden"></div>
                
                <div id="shoppingListResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep8" onclick="prevStep()">Back to Meal Plan</button>
                    <button class="btn" id="viewRecipesBtn" onclick="showRecipes()">View Recipes</button>
                    <button class="btn" id="downloadShoppingListBtn" onclick="downloadShoppingList()">Download List</button>
                </div>
            </div>
        </div>

        <div class="step" id="step9">
            <div class="card">
                <h2><span style="margin-right: 10px;">üßë‚Äçüç≥</span> Meal Prep & Recipe Guide</h2>
                <div id="step9-error-message" class="warning hidden"></div>
                
                <div id="recipeResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep9" onclick="showShoppingList()">Back to Shopping List</button>
                    <button class="btn" id="viewBenefitsBtn" onclick="showBenefits()">View Impact Summary</button>
                    <button class="btn" id="downloadRecipesBtn" onclick="downloadRecipes()">Download Recipes</button>
                    <button class="btn" id="restartBtnFromRecipes" onclick="restart()">Start Over</button>
                </div>
            </div>
        </div>
        
        <div class="step" id="step10">
            <div class="card">
                <h2><span style="margin-right: 10px;">üåç</span> Impact of Your Vegan Diet</h2>
                <div id="step10-error-message" class="warning hidden"></div>
                
                <div id="comparativeBenefitsSection" class="benefits-section">
                    <h4>Animal Lives Saved</h4>
                    <ul>
                        <li id="animalsSavedWeek"></li>
                        <li id="animalsSavedYear"></li>
                    </ul>

                    <h4>Environmental Impact Saved</h4>
                    <ul>
                        <li id="landSaved"></li>
                        <li id="co2Saved"></li>
                        <li id="waterSaved"></li>
                    </ul>

                    <div class="b12-disclaimer">
                        <p><strong>Important Note on Vitamin B12:</strong> As a vegan, ensuring adequate Vitamin B12 intake is crucial. The recommended daily intake for adults is 2.4 micrograms (mcg). It is highly recommended to supplement with B12 or consume B12-fortified foods regularly.</p>
                        <button onclick="openB12Modal()">Learn more about B12</button>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtnStep10" onclick="showRecipesBack()">Back to Recipes</button>
                    <button class="btn" id="showMealPlanBtn" onclick="showMealPlan()">Back to Meal Plan</button>
                    <button class="btn" id="restartBtnFromBenefits" onclick="restart()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeInfoModal()">‚úñ</button>
            <h2>How Calculations Are Made</h2>
            <p>The calculations used in this planner provide estimations based on widely accepted formulas in nutritional science. It's important to remember these are approximations, and individual needs can vary.</p>

            <h3>Basal Metabolic Rate (BMR) & Total Daily Energy Expenditure (TDEE)</h3>
            <p>Your Basal Metabolic Rate (BMR) is the number of calories your body needs to perform basic, life-sustaining functions when at rest. Your Total Daily Energy Expenditure (TDEE) is an estimate of how many calories you burn per day, including physical activity.</p>
            <ul>
                <li><a href="https://pubmed.ncbi.nlm.nih.gov/2305711/" target="_blank">A new predictive equation for resting energy expenditure in healthy individuals (Mifflin, St Jeor, 1990)</a></li>
                <li><a href="https://www.researchgate.net/publication/384950082_Comprehensive_Review_on_BMI_TDEE_BMR_and_Calories_for_Weight_Management: Insights into Energy Expenditure and Nutrient Balance for Long-Term Well-Being" target="_blank">Comprehensive Review on BMI, TDEE, BMR, and Calories for Weight Management (ResearchGate)</a></li>
            </ul>

            <h3>Body Fat Percentage Estimation</h3>
            <p>If not provided directly, body fat percentage is estimated based on reported gender and selected body type (lean/ectomorph, average/mesomorph, stocky/endomorph). These are very general approximations. For more precise measurements, consider methods like DEXA scans or bioelectrical impedance analysis.</p>
            <ul>
                <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2769821/" target="_blank">Body Composition Methods: Comparisons and Interpretation (PubMed Central)</a></li>
                <li><a href="https://www.annfammed.org/content/early/2025/06/23/afm.240330" target="_blank" >Body Mass Index vs Body Fat Percentage as a Predictor of Mortality in Adults Aged 20-49 Years (Annals of Family Medicine)</a></li>
            </ul>

            <h3>Muscle Mass Estimation</h3>
            <p>Muscle mass, when not directly provided, is estimated as a percentage of your lean body mass (total weight minus fat mass). This is a simplified approach, as precise muscle mass measurement typically requires advanced imaging techniques.</p>
            <ul>
                <li><a href="https://www.mdpi.com/2072-6643/12/3/755" target="_blank">Reference Values for Skeletal Muscle Mass ‚Äì Current Concepts and Methodological Considerations (MDPI)</a></li>
                <li><a href="https://www.researchgate.net/publication/378657737_Skeletal_muscle_estimation: A review of techniques and their applications" target="_blank">Skeletal muscle estimation: A review of techniques and their applications (ResearchGate)</a></li>
            </ul>
        </div>
    </div>

    <div id="advantagesModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeAdvantagesModal()">‚úñ</button>
            <h2>Advantages of a Vegan Diet</h2>
            <p>A well-planned vegan diet can offer numerous benefits for your health, for animals, and for the environment.</p>

            <h3>For Your Health</h3>
            <p>Vegan diets are typically rich in fiber, vitamins, and minerals, and lower in saturated fat and cholesterol. This can contribute to a reduced risk of various chronic diseases.</p>
            <ul>
                <li><a href="https://www.frontiersin.org/journals/nutrition/articles/10.3389/fnut.2023.1294497/full" target="_blank">Frontiers in Nutrition: Effect of plant-based dietary patterns on cardiometabolic health: a systematic review and meta-analysis of randomized controlled trials (2023)</a></li>
                <li><a href="https://www.hopkinsmedicine.org/health/wellness-and-prevention/how-to-maintain-a-balanced-diet-as-a-vegetarian-or-vegan" target="_blank">Johns Hopkins Medicine: How to Maintain a Balanced Diet as a Vegetarian or Vegan</a></li>
                <li><a href="https://www.rush.edu/news/health-benefits-vegan-diet" target="_blank">Rush University Medical Center: The Health Benefits of a Vegan Diet</a></li>
                <li><a href="https://www.nhs.uk/live-well/eat-well/how-to-eat-a-balanced-diet/the-vegan-diet/" target="_blank">NHS: The vegan diet</a></li>
                <li><a href="https://www.health.harvard.edu/heart-health/more-evidence-that-plant-based-diet-might-ward-off-heart-problems" target="_blank">Harvard Health Publishing: More evidence that plant-based diets might ward off heart problems</a></li>
                <li><a href="https://nutritionj.biomedcentral.com/articles/10.1186/s12937-023-00877-2" target="_blank">Nutrition Journal: Vegan diet and metabolic health in adolescents: a narrative review (2023)</a></li>
                <li><a href="https://www.who.int/news-room/questions-and-answers/item/cancer-carcinogenicity-of-the-consumption-of-red-meat-and-processed-meat" target="_blank">WHO: Cancer: Carcinogenicity of the consumption of red meat and processed meat</a></li>
            </ul>

            <h3>For the Animals</h3>
            <p>Choosing a vegan diet is a direct way to avoid supporting industrial animal agriculture, which is often associated with animal suffering and exploitation. It aligns with ethical considerations regarding animal sentience and the right to live free from human-imposed harm.</p>
            <p>For a deeper understanding of animal agriculture and its ethical implications, consider watching these documentaries or visiting these informative websites:</p>
            <ul>
                <li><strong>Dominion:</strong> A powerful documentary exposing the realities of animal agriculture. Free to watch at <a href="https://www.dominionmovement.com/watch" target="_blank">dominionmovement.com/watch</a></li>
                <li><strong>Okja:</strong> A fictional film with a strong message about animal rights and the food industry, available on Netflix.</li>
                <li><strong>Cowspiracy:</strong> Explores the environmental impact of animal agriculture. Available on Netflix.</li>
                <li><strong>The Game Changers:</strong> Focuses on plant-based diets for elite athletes. Available on Netflix.</li>
                <li><strong>Challenge 22:</strong> Offers a free, 22-day vegan challenge with mentorship and recipes. Visit <a href="https://challenge22.com/" target="_blank">challenge22.com</a></li>
                <li><strong>The Vegan Society:</strong> Provides extensive information and resources on veganism. Visit <a href="https://www.vegansociety.com/" target="_blank">vegansociety.com</a></li>
            </ul>

            <h3>For the Environment</h3>
            <p>Animal agriculture is a significant contributor to greenhouse gas emissions, deforestation, water pollution, and biodiversity loss. A shift towards plant-based diets can substantially reduce your environmental footprint.</p>
            <ul>
                <li><a href="https://www.ingredion.com/na/en-us/be-whats-next/plant-based-eating-living-for-sustainable-future.html" target="_blank">Ingredion: Plant-Based Eating & Living for a Sustainable Future</a></li>
                <li><a href="https://www.vegansociety.com/news/media/statistics/environment-and-sustainability" target="_blank">The Vegan Society: Environment & Sustainability Statistics</a></li>
                <li><a href="https://cafegratitude.com/blogs/news/happy-earth-month-how-eating-plant-based-can-have-a-positive-impact-on-the-environment" target="_blank">Cafe Gratitude: Happy Earth Month: How Eating Plant-Based Can Have A Positive Impact On The Environment</a></li>
                <li><a href="https://veganoutreach.org/environment/" target="_blank">Vegan Outreach: Environmental Benefits of a Vegan Diet</a></li>
                <li><a href="https://www.theguardian.com/environment/2023/jul/20/vegan-diet-cuts-environmental-damage-climate-heating-emissions-study" target="_blank">The Guardian: Vegan diet ‚Äòcuts environmental damage‚Äô more than other meat-free living, study finds</a></li>
                <li><a href="https://www.vegansociety.com/go-vegan/why-go-vegan" target="_blank">The Vegan Society: Why Go Vegan?</a></li>
                <li>Poore, J., & Nemecek, T. (2018). Reducing food‚Äôs environmental impacts through producers and consumers. <a href="https://www.science.org/doi/10.1126/science.aaq0216" target="_blank"><em>Science</em>, 360(6392), 987-992.</a></li>
            </ul>
        </div>
    </div>

    <div id="b12Modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeB12Modal()">‚úñ</button>
            <h2>Understanding Vitamin B12</h2>
            <p>Vitamin B12 (cobalamin) is an essential nutrient required for red blood cell formation, neurological function, and DNA synthesis. Unlike other vitamins, B12 is not produced by plants or animals themselves. It is synthesized by certain bacteria.</p>
            <p>Historically, humans obtained B12 from bacteria in soil and unwashed foods. However, modern sanitation practices have largely removed these sources from our diets.</p>
            <p>Farm animals, particularly those raised in intensive systems, often do not get enough B12 from their feed alone due to modern farming methods and sterile environments. As a result, B12 supplements are commonly added to animal feed to ensure their health and to enrich the meat, dairy, and eggs produced for human consumption.</p>
            <p>Therefore, whether you eat animal products or not, many people are effectively consuming B12 that was produced by bacteria and then supplemented. Vegans directly supplement with B12, making it a reliable and ethical source.</p>
            <h3>Scientific References:</h3>
            <ul>
                <li><a href="https://www.mdpi.com/2674-0311/3/2/10" target="_blank">MDPI: Vitamin B12 in Vegan Diets: A Critical Review and Practice Guide (2023)</a></li>
            </ul>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- *** Linking the external mealsData.js file *** -->
    <script src="mealsData.js"></script>

    <script>
        // The allMeals and ingredientCategories objects will be loaded from the mealsData.js file.

        // JavaScript Logic
        let currentStep = 1;
        let userData = {};
        let nutritionPlan = {};
        let mealPlan = {}; 
        let shoppingList = {};
        let recipes = {}; 
        let preliminaryMealChoices = {};

        const totalSteps = 10; 

        // Dark Mode Toggle Logic
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
            darkModeIcon.innerText = '‚òÄÔ∏è';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            darkModeIcon.innerText = '';
        }

        darkModeToggle.addEventListener('click', () => {
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                darkModeIcon.innerText = 'üåô';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                darkModeIcon.innerText = '‚òÄÔ∏è';
            }
        });

        function updateProgress() {
            const progressPercent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        function showStep(stepNumber) {
            console.log('Attempting to show step:', stepNumber);

            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            let stepId = (stepNumber === 'loading') ? 'loading' : `step${stepNumber}`;
            const stepElement = document.getElementById(stepId);
            
            if (stepElement) {
                stepElement.classList.add('active');
                console.log('Step element found and activated:', stepId);
            } else {
                console.error('ERROR: Step element NOT FOUND in HTML for ID:', stepId);
            }

            if (stepNumber !== 'loading') {
                currentStep = stepNumber;
                updateProgress();
            }
            updateSummaryCard();
            const summaryCard = document.getElementById('summaryCard');
            if (currentStep > 1 && currentStep < totalSteps + 1) {
                summaryCard.classList.remove('hidden');
            } else {
                summaryCard.classList.add('hidden');
            }
        }

        function nextStep() {
            console.log('Next button clicked. Current step:', currentStep);
            if (validateCurrentStep()) {
                console.log('Validation passed for step', currentStep);
                currentStep++;
                console.log('New current step after incrementing:', currentStep);
                showStep(currentStep);
            } else {
                console.warn('Validation failed for step', currentStep, '. Not advancing.');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function displayErrorMessage(stepId, message) {
            const errorDiv = document.getElementById(`${stepId}-error-message`);
            if (errorDiv) {
                errorDiv.innerText = message;
                errorDiv.classList.remove('hidden');
            } else {
                console.error(`Error div not found for step ${stepId}`);
                alert(message);
            }
        }

        function clearErrorMessages() {
            document.querySelectorAll('.warning').forEach(el => {
                if (el.id.includes('-error-message')) {
                    el.classList.add('hidden');
                    el.innerText = '';
                }
            });
            document.querySelectorAll('input, select').forEach(el => {
                el.style.borderColor = '';
            });
        }

        function validateCurrentStep() {
            clearErrorMessages();
            let isValid = true;
            let errorMessage = '';
            const currentStepElementId = `step${currentStep}`;

            switch (currentStep) {
                case 1:
                    const weightInput = document.getElementById('weight');
                    const heightInput = document.getElementById('height');
                    const ageInput = document.getElementById('age');

                    if (!weightInput.value || isNaN(weightInput.value) || parseFloat(weightInput.value) <= 0) {
                        errorMessage += 'Please enter a valid weight (greater than 0). ';
                        weightInput.style.borderColor = 'red';
                        isValid = false;
                    }
                    
                    if (!heightInput.value || isNaN(heightInput.value) || parseFloat(heightInput.value) <= 0) {
                        errorMessage += 'Please enter a valid height (greater than 0). ';
                        heightInput.style.borderColor = 'red';
                        isValid = false;
                    }

                    if (!ageInput.value || isNaN(ageInput.value) || parseInt(ageInput.value) < 15 || parseInt(ageInput.value) > 100) {
                        errorMessage += 'Please enter a valid age between 15 and 100. ';
                        ageInput.style.borderColor = 'red';
                        isValid = false;
                    }

                    if (isValid) {
                        userData.planName = document.getElementById('planName').value;
                        userData.weight = parseFloat(weightInput.value);
                        userData.height = parseFloat(heightInput.value);
                        userData.gender = document.getElementById('gender').value;
                        userData.age = parseInt(ageInput.value);
                        userData.activityLevel = document.getElementById('activityLevel').value;
                        userData.bodyType = document.getElementById('bodyType').value;
                        userData.bodyFat = parseFloat(document.getElementById('bodyFat').value);
                        userData.muscleMass = parseFloat(document.getElementById('muscleMass').value) || 0;
                        // DO NOT set userData.dailyCaloriesBurned here. It will be calculated or taken from the slider later.
                    }
                    break;
                case 2:
                    const goalInput = document.getElementById('goal');

                    if (!goalInput.value) {
                        errorMessage += 'Please select a primary goal. ';
                        goalInput.style.borderColor = 'red';
                        isValid = false;
                    }

                    if (isValid) {
                        userData.goal = goalInput.value;
                        if (userData.goal === 'lose' || userData.goal === 'recomp') {
                            const weightLossRateInput = document.getElementById('weightLossRate');
                            if (weightLossRateInput) {
                                userData.weightLossRate = parseFloat(weightLossRateInput.value);
                            }
                        }
                    }
                    break;
                case 3:
                    userData.foodExclusions = Array.from(document.querySelectorAll('#foodExclusions input[type="checkbox"]:checked')).map(cb => cb.value);
                    userData.milkPreference = document.getElementById('milkPreference').value;
                    isValid = true;
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                case 10:
                    isValid = true;
                    break;
                default:
                    isValid = true;
                    break;
            }

            if (!isValid && errorMessage) {
                displayErrorMessage(currentStepElementId, errorMessage.trim());
                console.error('Validation Error for step', currentStep, ':', errorMessage.trim());
            } else if (isValid) {
                console.log('Validation successful for step', currentStep);
                clearErrorMessages();
            }
            return isValid;
        }

        function updateSummaryCard() {
            const summaryCard = document.getElementById('summaryCard');
            let summaryHtml = `
                <div class="summary-item"><strong>${userData.planName || 'Your Plan'}</strong></div>
                <div class="summary-item"><strong>Goal:</strong> ${userData.goal ? userData.goal.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'N/A'}</div>
            `;
            if (nutritionPlan.targetCalories) {
                summaryHtml += `<div class="summary-item"><strong>Calories:</strong> ${nutritionPlan.targetCalories} kcal</div>`;
                summaryHtml += `<div class="summary-item"><strong>Protein:</strong> ${nutritionPlan.protein.grams}g</div>`;
            }
            summaryCard.innerHTML = summaryHtml;
        }

        function toggleWeightLossRate() {
            const goal = document.getElementById('goal').value;
            const weightLossGroup = document.getElementById('weightLossGroup');
            const aggressiveOption = document.getElementById('aggressiveOption');
            const aggressiveWarning = document.getElementById('aggressiveWarning');
            
            let currentBodyFat = parseFloat(document.getElementById('bodyFat').value) || 0;
            if (currentBodyFat === 0) {
                currentBodyFat = estimateBodyFatPercentage(userData.gender, userData.bodyType);
            }

            if (goal === 'lose' || goal === 'recomp') {
                weightLossGroup.classList.remove('hidden');
                
                if (currentBodyFat <= 35) {
                    aggressiveOption.disabled = true;
                    aggressiveOption.style.display = 'none';
                    aggressiveWarning.classList.remove('hidden');
                } else {
                    aggressiveOption.disabled = false;
                    aggressiveOption.style.display = 'block';
                    aggressiveWarning.classList.add('hidden');
                }
            } else {
                weightLossGroup.classList.add('hidden');
            }
        }

        function calculateBMR(weight, height, age, gender) {
            weight = parseFloat(weight) || 0;
            height = parseFloat(height) || 0;
            age = parseInt(age) || 0;

            if (weight === 0 || height === 0 || age === 0) {
                console.warn("Invalid inputs for BMR calculation. Returning 0.");
                return 0;
            }

            if (gender === 'male' || gender === 'trans_male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else if (gender === 'female' || gender === 'trans_female') {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            } else {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }


        function estimateTDEE(weight, height, age, gender, activityLevel) {
            const bmr = calculateBMR(weight, height, age, gender);
            if (bmr === 0) return 0;

            const activityFactors = {
                'sedentary': 1.2,
                'lightly_active': 1.375,
                'moderately_active': 1.55,
                'very_active': 1.725,
                'extremely_active': 1.9
            };
            return bmr * (activityFactors[activityLevel] || 1.2);
        }

        function estimateBodyFatPercentage(gender, bodyType) {
            if (gender === 'male' || gender === 'trans_male') {
                switch (bodyType) {
                    case 'lean': return 12;
                    case 'average': return 18;
                    case 'stocky': return 25;
                }
            } else if (gender === 'female' || gender === 'trans_female') {
                switch (bodyType) {
                    case 'lean': return 22;
                    case 'average': return 28;
                    case 'stocky': return 35;
                }
            }
            return 20;
        }

        function estimateMuscleMass(weight, bodyFat) {
            weight = parseFloat(weight) || 0;
            bodyFat = parseFloat(bodyFat) || 0;
            if (weight === 0 || bodyFat === 0) return 0;

            const leanBodyMass = weight * (1 - (bodyFat / 100));
            return leanBodyMass * 0.65;
        }

        function calculateNutrition() {
            if (!validateCurrentStep()) return;

            userData.weight = parseFloat(userData.weight) || 0;
            userData.height = parseFloat(userData.height) || 0;
            userData.age = parseInt(userData.age) || 0;
            
            // Always calculate TDEE based on user stats
            const estimatedTDEE = estimateTDEE(
                userData.weight,
                userData.height,
                userData.age,
                userData.gender,
                userData.activityLevel
            );

            // Use the user's slider input only if they've changed it from the default
            const userCaloriesInput = parseFloat(document.getElementById('dailyCaloriesBurned').value);
            const caloriesSlider = document.getElementById('dailyCaloriesBurned');
            // A simple way to check if the slider was used is if its value is not the default
            // This assumes the user might slide it and slide it back to 2000, which is a minor edge case.
            // A more robust way would be to add an event listener.
            if (userCaloriesInput !== 2000) { 
                 userData.dailyCaloriesBurned = userCaloriesInput;
            } else {
                userData.dailyCaloriesBurned = estimatedTDEE;
            }

            if (isNaN(userData.dailyCaloriesBurned) || userData.dailyCaloriesBurned <= 0) {
                userData.dailyCaloriesBurned = 2000;
                console.warn("Daily calories burned estimate failed or was zero, defaulting to 2000 kcal.");
            }

            if (userData.bodyFat === 0) {
                userData.bodyFat = estimateBodyFatPercentage(
                    userData.gender,
                    userData.bodyType
                );
            }
            if (isNaN(userData.bodyFat) || userData.bodyFat <= 0) {
                userData.bodyFat = 20;
                console.warn("Body fat estimate failed or was zero, defaulting to 20%.");
            }

            if (userData.muscleMass === 0) {
                userData.muscleMass = estimateMuscleMass(
                    userData.weight,
                    userData.bodyFat
                );
            }
            if (isNaN(userData.muscleMass) || userData.muscleMass <= 0) {
                userData.muscleMass = userData.weight * 0.4;
                console.warn("Muscle mass estimate failed or was zero, using rough fallback.");
            }
            
            let targetCalories = userData.dailyCaloriesBurned;
            let deficit = 0;
            
            switch(userData.goal) {
                case 'lose':
                    const weightLossRateVal = parseFloat(document.getElementById('weightLossRate').value);
                    userData.weightLossRate = isNaN(weightLossRateVal) ? 0.5 : weightLossRateVal;
                    deficit = userData.weightLossRate * 7700 / 7;
                    targetCalories = userData.dailyCaloriesBurned - deficit;
                    break;
                case 'gain':
                    targetCalories = userData.dailyCaloriesBurned + 300;
                    break;
                case 'recomp':
                    const recompWeightLossRateVal = parseFloat(document.getElementById('weightLossRate').value);
                    userData.weightLossRate = isNaN(recompWeightLossRateVal) ? 0.25 : recompWeightLossRateVal;
                    deficit = (userData.weightLossRate * 7700 / 7) * 0.5;
                    targetCalories = userData.dailyCaloriesBurned - deficit;
                    break;
                case 'gain_weight':
                    targetCalories = userData.dailyCaloriesBurned + 500;
                    break;
                case 'maintain':
                default:
                    break;
            }

            if (isNaN(targetCalories) || targetCalories <= 0) {
                console.error("Calculated targetCalories is invalid after goal adjustment:", targetCalories);
                targetCalories = 1800;
                displayErrorMessage(currentStepElementId, "Warning: Calorie target calculation resulted in an invalid number. Defaulting to 1800 kcal. Please check your inputs.");
            }
            if (isNaN(deficit)) {
                deficit = 0;
            }

            const protein = Math.round(userData.weight * 2.2);
            const proteinCals = protein * 4;
            let fatCals = Math.round(targetCalories * 0.25);
            let fat = Math.round(fatCals / 9);
            let carbCals = targetCalories - proteinCals - fatCals;
            let carbs = Math.round(carbCals / 4);

            if (carbCals < 0) {
                carbCals = 0;
                carbs = 0;
            }
            if (fatCals < 0) {
                fatCals = 0;
                fat = 0;
            }
            
            const proteinPercent = targetCalories > 0 ? Math.round((proteinCals / targetCalories) * 100) : 0;
            const carbsPercent = targetCalories > 0 ? Math.round((carbCals / targetCalories) * 100) : 0;
            const fatPercent = targetCalories > 0 ? Math.round((fatCals / targetCalories) * 100) : 0;

            nutritionPlan = {
                targetCalories: Math.round(targetCalories),
                deficit: Math.round(deficit),
                protein: { grams: protein, calories: proteinCals, percent: proteinPercent },
                carbs: { grams: carbs, calories: carbCals, percent: carbsPercent },
                fat: { grams: fat, calories: fatCals, percent: fatPercent },
                vegetables: { grams: 400, recommendation: "5+ servings daily" }
            };
            
            displayNutritionSummary();
            nextStep();
        }

        function displayNutritionSummary() {
            const summary = document.getElementById('nutritionSummary');
            const goalTextMap = { 
                maintain: 'Maintain Current Weight',
                lose: 'Fat Loss',
                gain: 'Muscle Gain',
                recomp: 'Body Recomposition',
                gain_weight: 'Weight Gain'
            };
            
            const userSelectedGoal = userData.goal; 
            let displayGoal = 'Goal Not Selected'; 

            if (userSelectedGoal && goalTextMap[userSelectedGoal]) {
                displayGoal = goalTextMap[userSelectedGoal];
            } else if (userSelectedGoal) {
                displayGoal = userSelectedGoal.charAt(0).toUpperCase() + userSelectedGoal.slice(1);
            }
            
            summary.innerHTML = `
                <h3>Goal: ${displayGoal}</h3>
                <div style="margin: 15px 0;">
                    <strong>Daily Calorie Target: ${nutritionPlan.targetCalories} calories</strong>
                    ${nutritionPlan.deficit > 0 ? `<br><em>Daily Deficit: ${nutritionPlan.deficit} calories</em>` : ''}
                    ${userData.goal === 'gain' ? `<br><em>Daily Surplus: 300 calories</em>` : ''}
                    ${userData.goal === 'gain_weight' ? `<br><em>Daily Surplus: 500 calories</em>` : ''}
                </div>
                <div class="macro-grid">
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.protein.grams}g</div><div>Protein (${nutritionPlan.protein.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.carbs.grams}g</div><div>Carbs (${nutritionPlan.carbs.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.fat.grams}g</div><div>Fat (${nutritionPlan.fat.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">400g+</div><div>Vegetables</div></div>
                </div>`;
        }

        function prepareMealReview() {
        userData.cookingFreq = document.getElementById('cookingFreq').value;
        userData.variety = document.getElementById('variety').value;
        userData.numWeeks = parseInt(document.getElementById('numWeeks').value, 10);
        userData.substitutePreference = document.getElementById('substitutePreference').value;
        userData.cuisinePreferences = Array.from(document.querySelectorAll('#cuisinePreferences input[type="checkbox"]:checked')).map(cb => cb.value);

        // This is a special instruction for the meal plan itself, not a food exclusion
        // We add it here so if a user checks "gluten", we know to modify the text later.
        if (document.getElementById('gluten').checked) {
            if (!userData.foodExclusions.includes('gluten')) {
                 userData.foodExclusions.push('gluten');
            }
        } else {
            userData.foodExclusions = userData.foodExclusions.filter(ex => ex !== 'gluten');
        }


        if (!validateCurrentStep()) return;
        
        const mealsToFilter = JSON.parse(JSON.stringify(allMeals));
        const mealChoiceMap = { 'low': 1, 'medium': Math.ceil(7 / 2), 'high': 7 };
        const numUniqueMealsDesired = mealChoiceMap[userData.variety] || 7;

        const selectUniqueMeals = (arr, count) => {
            if (!arr || arr.length === 0) return [];
            const shuffled = arr.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.min(count, shuffled.length));
        };

        const filteredMeals = {};
        Object.keys(mealsToFilter).forEach(mealType => {
            filteredMeals[mealType] = mealsToFilter[mealType].filter(meal => {
                // NEW LOGIC: Check if any of the user's exclusions match any of the ingredient's tags.
                // This will correctly filter out a meal with "bread" if the user checks "gluten".
                const hasExcludedIngredient = userData.foodExclusions.some(exclusion => 
                    meal.ingredients.some(ing => ing.tags && ing.tags.includes(exclusion))
                );
                return !hasExcludedIngredient;
            });
        });

            if (userData.milkPreference && userData.milkPreference !== 'any') {
                Object.keys(filteredMeals).forEach(mealType => {
                    filteredMeals[mealType] = filteredMeals[mealType].filter(meal => {
                        const mealIngredients = meal.ingredients.map(ing => ing.item.toLowerCase());
                        const hasGenericPlantMilk = mealIngredients.some(ing => ing.includes('plant milk'));
                        const hasSpecificMilk = mealIngredients.some(ing => ing.includes(userData.milkPreference + ' milk'));

                        if (hasGenericPlantMilk) return true;
                        if (mealIngredients.some(ing => ing.includes('almond milk') || ing.includes('soy milk') || ing.includes('oat milk') || ing.includes('coconut milk'))) {
                            return hasSpecificMilk;
                        }
                        return true;
                    });
                });
            }

            if (userData.cuisinePreferences && userData.cuisinePreferences.length > 0) {
                Object.keys(filteredMeals).forEach(mealType => {
                    filteredMeals[mealType] = filteredMeals[mealType].filter(meal =>
                        userData.cuisinePreferences.includes(meal.cuisine)
                    );
                });
            }

            preliminaryMealChoices = {
                breakfast: selectUniqueMeals(filteredMeals.breakfast, numUniqueMealsDesired),
                lunch: selectUniqueMeals(filteredMeals.lunch, numUniqueMealsDesired),
                dinner: selectUniqueMeals(filteredMeals.dinner, numUniqueMealsDesired),
                snacks: selectUniqueMeals(filteredMeals.snacks, numUniqueMealsDesired)
            };
            
            let missingMealTypes = [];
            const essentialMealTypes = ['breakfast', 'lunch', 'dinner']; 
            
            essentialMealTypes.forEach(type => {
                if (preliminaryMealChoices[type].length === 0) {
                    missingMealTypes.push(type.charAt(0).toUpperCase() + type.slice(1));
                }
            });

            if (missingMealTypes.length > 0) {
                const errorMessage = `Could not find enough meals for: ${missingMealTypes.join(', ')}. Please go back and adjust your preferences.`;
                displayErrorMessage('step5', errorMessage);
                return;
            }
            if (userData.foodExclusions.includes('gluten')) {
            Object.values(preliminaryMealChoices).forEach(mealArray => {
                mealArray.forEach(meal => {
                    meal.ingredients.forEach(ing => {
                        if (ing.item.toLowerCase().includes('bread') || ing.item.toLowerCase().includes('toast')) {
                            ing.item = 'gluten-free bread';
                        }
                        if (ing.item.toLowerCase().includes('pasta')) {
                            ing.item = 'gluten-free pasta';
                        }
                        if (ing.item.toLowerCase().includes('oats')) {
                            ing.item = 'gluten-free oats';
                        }
                        if (ing.item.toLowerCase().includes('tortilla')) {
                            ing.item = 'gluten-free tortilla';
                        }
                         if (ing.item.toLowerCase().includes('soy sauce')) {
                            ing.item = 'tamari (gluten-free soy sauce)';
                        }
                    });
                });
            });
        }
            displayMealReview();
            nextStep();
        }

        function displayMealReview() {
            const reviewSection = document.getElementById('mealReviewSection');
            let html = '';
            
            const mealTypes = ['Breakfast', 'Lunch', 'Dinner', 'Snacks'];
            mealTypes.forEach(type => {
                const typeLower = type.toLowerCase();
                if (preliminaryMealChoices[typeLower] && preliminaryMealChoices[typeLower].length > 0) {
                    html += `<div class="meal-review-category"><h4>${type}</h4><div class="checkbox-group">`;
                    preliminaryMealChoices[typeLower].forEach(meal => {
                        html += `
                            <div class="checkbox-item">
                                <input type="checkbox" id="meal_${meal.name.replace(/\s+/g, '_').replace(/'/g, '')}" value="${meal.name}" data-meal-type="${typeLower}" checked>
                                <label for="meal_${meal.name.replace(/\s+/g, '_').replace(/'/g, '')}">${meal.name}</label>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
            });
            
            reviewSection.innerHTML = html;
        }

          function generateMealPlan() {
        if (!validateCurrentStep()) return;
        showStep('loading');
        
        setTimeout(() => {
            try {
                const approvedMeals = { breakfast: [], lunch: [], dinner: [], snacks: [] };
                const excludedMealNames = new Set(); 

                const allReviewedMeals = document.querySelectorAll('#mealReviewSection input[type="checkbox"]');
                allReviewedMeals.forEach(checkbox => {
                    const mealType = checkbox.getAttribute('data-meal-type');
                    const mealName = checkbox.value;
                    const mealData = preliminaryMealChoices[mealType].find(m => m.name === mealName);
                    if (checkbox.checked) {
                        if (mealData) approvedMeals[mealType].push(mealData);
                    } else {
                        excludedMealNames.add(mealName);
                    }
                });

                Object.keys(approvedMeals).forEach(mealType => {
                    if (approvedMeals[mealType].length === 0 && preliminaryMealChoices[mealType] && preliminaryMealChoices[mealType].length > 0) {
                        console.warn(`User unchecked all ${mealType} meals. Finding replacements...`);
                        const mealChoiceMap = { 'low': 1, 'medium': Math.ceil(7 / 2), 'high': 7 };
                        const numReplacementsNeeded = mealChoiceMap[userData.variety] || 7;

                        // --- INICIO DE LA SECCI√ìN CORREGIDA ---
                        let potentialReplacements = allMeals[mealType]
                            .filter(meal => {
                                // L√ìGICA CORREGIDA: Usa el sistema de "tags" para filtrar
                                const hasExcludedIngredient = userData.foodExclusions.some(exclusion => 
                                    meal.ingredients.some(ing => ing.tags && ing.tags.includes(exclusion))
                                );
                                return !hasExcludedIngredient;
                            })
                            // --- FIN DE LA SECCI√ìN CORREGIDA ---
                            .filter(meal => {
                                if (userData.milkPreference && userData.milkPreference !== 'any') {
                                    const mealIngredients = meal.ingredients.map(ing => ing.item.toLowerCase());
                                    const hasGenericPlantMilk = mealIngredients.some(ing => ing.includes('plant milk'));
                                    const hasSpecificMilk = mealIngredients.some(ing => ing.includes(userData.milkPreference + ' milk'));
                                    if (hasGenericPlantMilk) return true;
                                    if (mealIngredients.some(ing => ing.includes('almond milk') || ing.includes('soy milk') || ing.includes('oat milk') || ing.includes('coconut milk'))) {
                                        return hasSpecificMilk;
                                    }
                                }
                                return true;
                            })
                            .filter(meal => !excludedMealNames.has(meal.name));

                        let replacements = [];
                        if (userData.cuisinePreferences && userData.cuisinePreferences.length > 0) {
                            replacements = potentialReplacements.filter(meal =>
                                userData.cuisinePreferences.includes(meal.cuisine)
                            );
                        }

                        if (replacements.length < numReplacementsNeeded) {
                            const existingReplacementNames = new Set(replacements.map(m => m.name));
                            const fallbackReplacements = potentialReplacements.filter(meal => !existingReplacementNames.has(meal.name));
                            replacements = [...replacements, ...fallbackReplacements];
                        }

                        const shuffled = replacements.sort(() => 0.5 - Math.random());
                        approvedMeals[mealType] = shuffled.slice(0, Math.min(numReplacementsNeeded, shuffled.length));

                        // Renombrar ingredientes a "sin gluten" si es necesario en los reemplazos
                        if (userData.foodExclusions.includes('gluten')) {
                           approvedMeals[mealType].forEach(meal => {
                                meal.ingredients.forEach(ing => {
                                    if (ing.item.toLowerCase().includes('bread') || ing.item.toLowerCase().includes('toast')) ing.item = 'gluten-free bread';
                                    if (ing.item.toLowerCase().includes('pasta')) ing.item = 'gluten-free pasta';
                                    if (ing.item.toLowerCase().includes('oats')) ing.item = 'gluten-free oats';
                                    if (ing.item.toLowerCase().includes('tortilla')) ing.item = 'gluten-free tortilla';
                                    if (ing.item.toLowerCase().includes('soy sauce')) ing.item = 'tamari (gluten-free soy sauce)';
                                });
                           });
                        }
                    }
                });

                let finalMissingMealTypes = [];
                ['breakfast', 'lunch', 'dinner'].forEach(type => {
                    if (!approvedMeals[type] || approvedMeals[type].length === 0) {
                        finalMissingMealTypes.push(type.charAt(0).toUpperCase() + type.slice(1));
                    }
                });

                if (finalMissingMealTypes.length > 0) {
                    displayErrorMessage('step6', `Could not find any replacement meals for: ${finalMissingMealTypes.join(', ')}. Your combination of allergies and preferences might be too restrictive. Please go back and adjust your selections.`);
                    showStep(6);
                    return;
                }

                createMealPlan(approvedMeals);
                showStep(7);
            } catch (error) {
                console.error('Error generating meal plan:', error);
                displayErrorMessage('step6', 'There was an unexpected error generating your meal plan. Please try again.');
                showStep(6);
            }
        }, 1500);
    }
                   
        function createMealPlan(approvedMeals) {
            const numWeeks = userData.numWeeks;
            mealPlan = {}; 
            recipes = {}; 
            shoppingList = {};

            for (let i = 1; i <= numWeeks; i++) {
                const weeklyPlan = generateWeeklyMealPlan(approvedMeals);
                mealPlan[`Week ${i}`] = weeklyPlan;

                Object.values(weeklyPlan).forEach(day => {
                    const allMealsForDay = [day.breakfast, day.lunch, day.dinner].concat(day.snacks);
                    allMealsForDay.forEach(meal => {
                        if (meal) {
                            const ingredientsForRecipe = meal.ingredients.map(ing => {
                                if (ing.item === 'plant milk' && userData.milkPreference !== 'any') {
                                    return { ...ing, item: userData.milkPreference + ' milk' };
                                }
                                return ing;
                            });
                            recipes[meal.name] = { ...meal, ingredients: ingredientsForRecipe };
                        }
                    });
                });
            }

            createShoppingList();
            displayMealPlan();
        }
        
        function generateWeeklyMealPlan(availableMeals) {
            const dailyCals = nutritionPlan.targetCalories;
            const mealTargets = {
                breakfast: dailyCals * 0.25,
                lunch: dailyCals * 0.35,
                dinner: dailyCals * 0.30,
            };

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const weekPlan = {};

            const scaleMeal = (meal, targetCalories) => {
                if (!meal || meal.calories === 0) return meal;
                const scaleFactor = targetCalories / meal.calories;
                
                const scaledMeal = JSON.parse(JSON.stringify(meal));
                scaledMeal.calories = Math.round(meal.calories * scaleFactor);
                scaledMeal.protein = Math.round(meal.protein * scaleFactor);

                const roundableUnits = ['slices', 'piece', 'pieces', 'tortilla', 'bun', 'roll', 'arepa', 'pancake', 'scone', 'flatbread', 'chapati', 'naan', 'pita', 'tostada', 'gyoza', 'sheet', 'patty'];

                scaledMeal.ingredients = meal.ingredients.map(ing => {
                    let newQuantity = parseFloat((ing.quantity * scaleFactor).toFixed(1));

                    const isRoundable = roundableUnits.some(unit => 
                        ing.unit.toLowerCase().includes(unit) || ing.item.toLowerCase().includes(unit)
                    );

                    if (isRoundable) {
                        newQuantity = Math.round(newQuantity);
                        if (newQuantity < 1) newQuantity = 1; 
                    }

                    return {
                        ...ing,
                        quantity: newQuantity
                    };
                });
                
                return scaledMeal;
            };

            days.forEach((day, index) => {
                let todaysMeals = { breakfast: null, lunch: null, dinner: null, snacks: [] };
                
                let baseBreakfast = availableMeals.breakfast[index % availableMeals.breakfast.length];
                let baseLunch = availableMeals.lunch[index % availableMeals.lunch.length];
                let baseDinner = availableMeals.dinner[index % availableMeals.dinner.length];

                todaysMeals.breakfast = scaleMeal(baseBreakfast, mealTargets.breakfast);
                todaysMeals.lunch = scaleMeal(baseLunch, mealTargets.lunch);
                todaysMeals.dinner = scaleMeal(baseDinner, mealTargets.dinner);
                
                let currentCalories = (todaysMeals.breakfast?.calories || 0) + 
                                      (todaysMeals.lunch?.calories || 0) + 
                                      (todaysMeals.dinner?.calories || 0);
                
                let remainingCals = dailyCals - currentCalories;

                if (remainingCals > 75 && availableMeals.snacks.length > 0) {
                    let availableSnacksForDay = [...availableMeals.snacks].sort((a,b) => b.calories - a.calories);

                    while (remainingCals > 75 && availableSnacksForDay.length > 0) {
                        let bestSnack = availableSnacksForDay.find(s => s.calories <= remainingCals);
                        
                        if (bestSnack) {
                            todaysMeals.snacks.push(bestSnack);
                            remainingCals -= bestSnack.calories;
                            availableSnacksForDay = availableSnacksForDay.filter(s => s.name !== bestSnack.name);
                        } else {
                            break; 
                        }
                    }
                }

                weekPlan[day] = todaysMeals;
            });
            return weekPlan;
        }


        function displayMealPlan() {
            const resultsDiv = document.getElementById('mealPlanResults');
            if (Object.keys(mealPlan).length === 0) {
                resultsDiv.innerHTML = '<p class="warning">Could not generate a meal plan. Please try adjusting your inputs.</p>';
                return;
            }
            let html = '';
            Object.keys(mealPlan).forEach(weekKey => {
                html += `<h3 style="text-align: center; margin-top: 30px; margin-bottom: 20px; color: #5a67d8;">${weekKey}</h3>`;
                const weeklyPlan = mealPlan[weekKey];
                Object.keys(weeklyPlan).forEach(day => {
                    const dayMeals = weeklyPlan[day];
                    const totalCals = (dayMeals.breakfast?.calories || 0) + 
                                      (dayMeals.lunch?.calories || 0) + 
                                      (dayMeals.dinner?.calories || 0) +
                                      dayMeals.snacks.reduce((sum, snack) => sum + snack.calories, 0);

                    let snacksHtml = '';
                    if (dayMeals.snacks.length > 0) {
                        dayMeals.snacks.forEach(snack => {
                            snacksHtml += `<div class="meal-item">${snack.name} (${snack.calories} cal)</div>`;
                        });
                    } else {
                        snacksHtml = `<div class="meal-item">N/A (0 cal)</div>`;
                    }

                    html += `
                        <div class="day-card">
                            <div class="day-header">${day} - ~${totalCals} calories</div>
                            <div class="meals">
                                <div class="meal"><div class="meal-type">üåÖ Breakfast</div><div class="meal-item">${dayMeals.breakfast ? dayMeals.breakfast.name : 'N/A'} (${dayMeals.breakfast ? dayMeals.breakfast.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">üåû Lunch</div><div class="meal-item">${dayMeals.lunch ? dayMeals.lunch.name : 'N/A'} (${dayMeals.lunch ? dayMeals.lunch.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">üåô Dinner</div><div class="meal-item">${dayMeals.dinner ? dayMeals.dinner.name : 'N/A'} (${dayMeals.dinner ? dayMeals.dinner.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">üçé Snack(s)</div>${snacksHtml}</div>
                            </div>
                        </div>`;
                });
            });
            resultsDiv.innerHTML = html;
        }

        function createShoppingList() {
            const allIngredients = {};
            Object.values(mealPlan).forEach(weeklyPlan => {
                Object.values(weeklyPlan).forEach(day => {
                    const allMealsForDay = [day.breakfast, day.lunch, day.dinner, ...day.snacks];
                    allMealsForDay.forEach(meal => {
                        if (meal && meal.ingredients) {
                            meal.ingredients.forEach(ing => {
                                const key = ing.item.toLowerCase();
                                let itemKey = key;
                                if (key === 'plant milk' && userData.milkPreference !== 'any') {
                                    itemKey = userData.milkPreference + ' milk';
                                }
                                if (!allIngredients[itemKey]) {
                                    allIngredients[itemKey] = { quantity: 0, unit: ing.unit };
                                }
                                allIngredients[itemKey].quantity += ing.quantity;
                                if(ing.unit === 'unit') allIngredients[itemKey].unit = 'units';
                            });
                        }
                    });
                });
            });

            shoppingList = {};
            Object.keys(ingredientCategories).forEach(cat => shoppingList[cat] = []);

            for (const [ingName, ingData] of Object.entries(allIngredients)) {
                let foundCategory = false;
                for (const [catName, catItems] of Object.entries(ingredientCategories)) {
                    if (catItems.some(item => ingName.includes(item.toLowerCase()))) {
                        shoppingList[catName].push({ name: ingName, ...ingData });
                        foundCategory = true;
                        break;
                    }
                }
                if (!foundCategory) {
                    if (!shoppingList['Other']) shoppingList['Other'] = [];
                    shoppingList['Other'].push({ name: ingName, ...ingData });
                }
            }

            if (userData.milkPreference !== 'any') {
                shoppingList['Plant Milks & Alternatives'] = shoppingList['Plant Milks & Alternatives'].filter(item => item.name !== 'plant milk');
            }
        }

        function createRecipeGuide() {
            if (Object.keys(recipes).length === 0) {
                console.warn('Recipes object is empty after meal plan generation.');
            }
        }

        function showShoppingList() {
            const resultsDiv = document.getElementById('shoppingListResults');
            let html = '<div class="shopping-list">';
            if (Object.keys(shoppingList).length === 0 || Object.values(shoppingList).every(arr => arr.length === 0)) {
                resultsDiv.innerHTML = '<p class="warning">No shopping list generated. Please ensure a meal plan was successfully created.</p>';
                return;
            }
            Object.entries(shoppingList).forEach(([category, items]) => {
                if (items.length > 0) {
                    html += `<div class="category-title">${category}</div><ul class="item-list">`;
                    items.forEach(item => {
                        html += `<li class="shopping-item">${formatShoppingListItem(item)}</li>`;
                    });
                    html += `</ul>`;
                }
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
            showStep(8);
        }

        function showRecipes() {
            const resultsDiv = document.getElementById('recipeResults');
            let html = '<div class="recipe-section">';
            if (Object.keys(recipes).length === 0) {
                resultsDiv.innerHTML = '<p class="warning">No recipes generated. Please ensure a meal plan was successfully created.</p>';
                return;
            }
            const sortedRecipeNames = Object.keys(recipes).sort();
            sortedRecipeNames.forEach(recipeName => {
                const recipe = recipes[recipeName];
                html += `
                    <div class="recipe-card">
                        <div class="recipe-title">${recipeName}</div>
                        <div class="recipe-info">
                            <span>üîã ${recipe.calories} cal</span>
                            <span>üí™ ${recipe.protein}g protein</span>
                            <span>‚è∞ ${recipe.cookingTime}</span>
                        </div>
                        <h4>Ingredients:</h4>
                        <ul class="ingredients-list">${recipe.ingredients.map(ing => `<li>${ing.quantity}${ing.unit} ${ing.item}</li>`).join('')}</ul>
                        <h4>Instructions:</h4>
                        <ol class="instructions-list">${recipe.instructions.split('. ').filter(s => s.trim()).map(s => `<li>${s.trim()}${s.endsWith('.')?'':'.'}</li>`).join('')}</ol>
                    </div>`;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
            showStep(9);
        }

        window.showBenefits = function() {
            displayComparativeBenefits();
            showStep(10);
        }

        window.showRecipesBack = function() {
            showStep(9);
        }

        function displayComparativeBenefits() {
            const benefitsSection = document.getElementById('comparativeBenefitsSection');
            const animalsSavedPerYear = 198;
            const animalsSavedPerWeek = (animalsSavedPerYear / 52);

            document.getElementById('animalsSavedWeek').innerHTML = `‚Ä¢ üêîüê∑üêü <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${(animalsSavedPerWeek * userData.numWeeks).toFixed(1)} animal lives</strong>.`;
            document.getElementById('animalsSavedYear').innerHTML = `‚Ä¢ üêîüê∑üêü <strong>Projected per year:</strong> Approximately <strong>${animalsSavedPerYear} animal lives</strong>.`;

            const landSavedSqMetersTotal = 18 * 7 * userData.numWeeks;
            const landSavedSqFtTotal = (landSavedSqMetersTotal * 10.764).toFixed(0);
            const co2SavedKgTotal = (2.5 - 0.7) * 7 * userData.numWeeks;
            const co2SavedLbsTotal = (co2SavedKgTotal * 2.20462).toFixed(1);
            const waterSavedLitersTotal = 4164 * 7 * userData.numWeeks;
            const waterSavedGallonsTotal = (waterSavedLitersTotal / 3.785).toFixed(0);

            const landSavedSqMetersYear = 18 * 365;
            const landSavedAcresYear = (landSavedSqMetersYear / 4046.86).toFixed(1);
            const co2SavedTonnesYear = ((2.5 - 0.7) * 365 / 1000).toFixed(2);
            const waterSavedMillionLitersYear = (4164 * 365 / 1000000).toFixed(2);

            document.getElementById('landSaved').innerHTML = `‚Ä¢ üå± <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${landSavedSqFtTotal} square feet</strong> (${landSavedSqMetersTotal} square meters) of land. (Enough for a small garden!)<br>‚Ä¢ üå± <strong>Projected per year:</strong> Approximately <strong>${landSavedAcresYear} acres</strong> of land.`;
            document.getElementById('co2Saved').innerHTML = `‚Ä¢ üí® <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${co2SavedKgTotal.toFixed(1)} kg CO2e</strong> (${co2SavedLbsTotal} lbs CO2e) of greenhouse gas emissions. (Equivalent to driving a car for ~${(co2SavedKgTotal / 0.22).toFixed(0)} km)<br>‚Ä¢ üåç <strong>Projected per year:</strong> Approximately <strong>${co2SavedTonnesYear} tonnes CO2e</strong>.`;
            document.getElementById('waterSaved').innerHTML = `‚Ä¢ üíß <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${waterSavedLitersTotal} liters</strong> (${waterSavedGallonsTotal} gallons) of water. (Enough for ~${(waterSavedLitersTotal / 150).toFixed(0)} showers!)<br>‚Ä¢ üöø <strong>Projected per year:</strong> Approximately <strong>${waterSavedMillionLitersYear} million liters</strong> of water.`;

            let existingSourcesDiv = benefitsSection.querySelector('.impact-sources');
            if (existingSourcesDiv) {
                existingSourcesDiv.remove();
            }

            let sourcesHtml = `
                <h4>Sources for Impact Data</h4>
                <ul>
                    <li><a href="https://www.vegansociety.com/go-vegan/why-go-vegan/animals" target="_blank">The Vegan Society: Why go vegan? (Animals)</a></li>
                    <li>Poore, J., & Nemecek, T. (2018). Reducing food‚Äôs environmental impacts through producers and consumers. <a href="https://www.science.org/doi/10.1126/science.aaq0216" target="_blank"><em>Science</em>, 360(6392), 987-992.</a></li>
                </ul>
            `;
            const sourcesDiv = document.createElement('div');
            sourcesDiv.classList.add('impact-sources');
            benefitsSection.appendChild(sourcesDiv);
            sourcesDiv.innerHTML = sourcesHtml;
        }

        window.showMealPlan = function() {
            showStep(7);
        }

        function downloadPlan() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let cursorY = margin;
            const contentWidth = pageWidth - 2 * margin;

            pdf.setFontSize(24);
            pdf.setTextColor(118, 75, 162);
            pdf.text("Your Personalized Vegan Meal Plan", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 15;

            pdf.setFontSize(12);
            pdf.setTextColor(74, 85, 104);
            const userInfo = [
                `Plan Name: ${userData.planName || 'N/A'}`,
                `Goal: ${userData.goal ? userData.goal.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'N/A'}`,
                `Target Calories: ${nutritionPlan.targetCalories} kcal`,
                `Protein: ${nutritionPlan.protein.grams}g | Carbs: ${nutritionPlan.carbs.grams}g | Fat: ${nutritionPlan.fat.grams}g`
            ];
            userInfo.forEach(line => {
                pdf.text(line, margin, cursorY);
                cursorY += 7;
            });
            cursorY += 5;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            const tableHeaders = ["Day", "Calories", "Meals"];
            const colWidths = [30, 30, contentWidth - 60];
            const colStarts = [margin, margin + colWidths[0], margin + colWidths[0] + colWidths[1]];
            const rowPadding = 3;

            pdf.setDrawColor(226, 232, 240);

            Object.keys(mealPlan).forEach(weekKey => {
                pdf.setFontSize(16);
                pdf.setTextColor(90, 103, 216);
                pdf.text(weekKey, pageWidth / 2, cursorY + 10, { align: "center" });
                cursorY += 20;

                pdf.setFontSize(10);
                pdf.setFillColor(243, 238, 252);
                pdf.rect(colStarts[0], cursorY, contentWidth, 8, 'F');
                tableHeaders.forEach((header, index) => {
                    pdf.setTextColor(74, 85, 104);
                    pdf.text(header, colStarts[index] + rowPadding, cursorY + 5);
                });
                cursorY += 8;

                const weeklyPlan = mealPlan[weekKey];
                Object.keys(weeklyPlan).forEach(day => {
                    const dayMeals = weeklyPlan[day];
                    const totalCals = (dayMeals.breakfast?.calories || 0) + 
                                      (dayMeals.lunch?.calories || 0) + 
                                      (dayMeals.dinner?.calories || 0) +
                                      dayMeals.snacks.reduce((sum, snack) => sum + snack.calories, 0);

                    let maxCellHeight = 0;

                    const dayCellContent = day;
                    const calCellContent = `~${totalCals} kcal`;
                    
                    let mealsListFormatted = [
                        `Breakfast: ${dayMeals.breakfast ? dayMeals.breakfast.name : 'N/A'} (${dayMeals.breakfast ? dayMeals.breakfast.calories : 0} kcal)`,
                        `Lunch: ${dayMeals.lunch ? dayMeals.lunch.name : 'N/A'} (${dayMeals.lunch ? dayMeals.lunch.calories : 0} kcal)`,
                        `Dinner: ${dayMeals.dinner ? dayMeals.dinner.name : 'N/A'} (${dayMeals.dinner ? dayMeals.dinner.calories : 0} kcal)`
                    ];
                    dayMeals.snacks.forEach(snack => {
                        mealsListFormatted.push(`Snack: ${snack.name} (${snack.calories} kcal)`);
                    });


                    let mealsLines = [];
                    mealsListFormatted.forEach(mealText => {
                        const lines = pdf.splitTextToSize(mealText, colWidths[2] - (2 * rowPadding));
                        mealsLines.push(...lines);
                    });
                    maxCellHeight = Math.max(maxCellHeight, mealsLines.length * 4.5);
                    maxCellHeight = Math.max(maxCellHeight, 15);

                    if (cursorY + maxCellHeight + rowPadding * 2 + margin > pageHeight) {
                        pdf.addPage();
                        cursorY = margin;
                        pdf.setFontSize(10);
                        pdf.setFillColor(243, 238, 252);
                        pdf.rect(colStarts[0], cursorY, contentWidth, 8, 'F');
                        tableHeaders.forEach((header, index) => {
                            pdf.setTextColor(74, 85, 104);
                            pdf.text(header, colStarts[index] + rowPadding, cursorY + 5);
                        });
                        cursorY += 8;
                    }

                    pdf.setLineWidth(0.2);
                    pdf.rect(colStarts[0], cursorY, colWidths[0], maxCellHeight + rowPadding * 2, 'S');
                    pdf.text(dayCellContent, colStarts[0] + rowPadding, cursorY + rowPadding + 3);

                    pdf.rect(colStarts[1], cursorY, colWidths[1], maxCellHeight + rowPadding * 2, 'S');
                    pdf.text(calCellContent, colStarts[1] + rowPadding, cursorY + rowPadding + 3);

                    pdf.rect(colStarts[2], cursorY, colWidths[2], maxCellHeight + rowPadding * 2, 'S');
                    let mealTextY = cursorY + rowPadding + 3;
                    mealsListFormatted.forEach(mealText => {
                        const lines = pdf.splitTextToSize(mealText, colWidths[2] - (2 * rowPadding));
                        lines.forEach(line => {
                            pdf.text(line, colStarts[2] + rowPadding, mealTextY);
                            mealTextY += 4.5;
                        });
                    });
                    cursorY += maxCellHeight + rowPadding * 2;
                });
                cursorY += 10;
            });

            pdf.save('vegan-meal-plan.pdf');
        }

        function downloadShoppingList() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let cursorY = margin;
            const contentWidth = pageWidth - 2 * margin;

            pdf.setFontSize(24);
            pdf.setTextColor(118, 75, 162);
            pdf.text("Your Vegan Shopping List", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 15;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);

            const col1X = margin;
            const col2X = pageWidth / 2 + 5;
            const itemLineHeight = 5;
            let currentColumn = 1;
            let col1Y = cursorY;
            let col2Y = cursorY;

            Object.entries(shoppingList).forEach(([category, items]) => {
                if (items.length > 0) {
                    const categoryTitle = category;
                    const titleHeight = 7;

                    if (currentColumn === 1 && col1Y + titleHeight > pageHeight - margin) {
                        currentColumn = 2;
                        col2Y = cursorY;
                    }
                    if (currentColumn === 2 && col2Y + titleHeight > pageHeight - margin) {
                        pdf.addPage();
                        cursorY = margin;
                        col1Y = cursorY;
                        col2Y = cursorY;
                        currentColumn = 1;
                    }

                    let currentY = (currentColumn === 1) ? col1Y : col2Y;
                    let currentX = (currentColumn === 1) ? col1X : col2X;

                    pdf.setFontSize(12);
                    pdf.setTextColor(66, 118, 234);
                    pdf.text(categoryTitle, currentX, currentY);
                    currentY += titleHeight;

                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);

                    items.forEach(item => {
                        const itemText = formatShoppingListItem(item);
                        const lines = pdf.splitTextToSize(itemText, (pageWidth / 2) - margin - 5);

                        lines.forEach(line => {
                            if (currentY + itemLineHeight > pageHeight - margin) {
                                if (currentColumn === 1) {
                                    currentColumn = 2;
                                    col2Y = cursorY;
                                    currentY = col2Y;
                                    currentX = col2X;
                                } else {
                                    pdf.addPage();
                                    cursorY = margin;
                                    col1Y = cursorY;
                                    col2Y = cursorY;
                                    currentY = cursorY;
                                    currentX = col1X;
                                    currentColumn = 1;
                                }
                            }
                            pdf.text(`‚Ä¢ ${line}`, currentX, currentY);
                            currentY += itemLineHeight;
                        });
                    });

                    if (currentColumn === 1) {
                        col1Y = currentY + 5;
                    } else {
                        col2Y = currentY + 5;
                    }
                    cursorY = Math.max(col1Y, col2Y);
                }
            });

            pdf.save('vegan-shopping-list.pdf');
        }

        function downloadRecipes() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let cursorY = margin;
            const cardPadding = 10;
            const sectionSpacing = 5;
            const infoLineHeight = 6;
            const listItemHeight = 5;
            const subtitleHeight = 7;

            pdf.setFontSize(24);
            pdf.setTextColor(118, 75, 162); // Purple
            pdf.text("Your Vegan Recipe Guide", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 15;

            const sortedRecipeNames = Object.keys(recipes).sort();

            sortedRecipeNames.forEach((recipeName, index) => {
                const recipe = recipes[recipeName];
                const x = margin;
                const width = pageWidth - 2 * margin;
                let cardStartY = cursorY;
                let contentX = x + cardPadding;
                let contentY = cardStartY + cardPadding;
                const currentContentWidth = width - 2 * cardPadding;

                const estimatedHeight = 10 + 3 * infoLineHeight + 
                                        (recipe.ingredients.length * listItemHeight) + 
                                        (recipe.instructions.split('. ').filter(s => s.trim()).length * listItemHeight) + 
                                        4 * sectionSpacing + 2 * subtitleHeight;

                if (cursorY + estimatedHeight + margin > pageHeight && index > 0) {
                    pdf.addPage();
                    cursorY = margin;
                    cardStartY = cursorY;
                    contentY = cardStartY + cardPadding;
                    pdf.setFontSize(24);
                    pdf.setTextColor(118, 75, 162);
                    pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                    cursorY += 20;
                    cardStartY = cursorY;
                    contentY = cursorY + cardPadding;
                }

                pdf.setFontSize(16);
                pdf.setTextColor(45, 55, 72);
                pdf.text(recipeName, contentX, contentY);
                contentY += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(113, 128, 150);
                pdf.text(`${recipe.calories} cal | ${recipe.protein}g protein | ${recipe.cookingTime}`, contentX, contentY);
                contentY += infoLineHeight + sectionSpacing;

                pdf.setFontSize(12);
                pdf.setTextColor(74, 85, 104);
                pdf.text("Ingredients:", contentX, contentY);
                contentY += subtitleHeight;
                pdf.setFontSize(10);
                recipe.ingredients.forEach(ing => {
                    const ingredientText = `‚Ä¢ ${ing.quantity}${ing.unit} ${ing.item}`;
                    const lines = pdf.splitTextToSize(ingredientText, currentContentWidth - 8);
                    lines.forEach(line => {
                        if (contentY + listItemHeight + margin > pageHeight) {
                            pdf.addPage();
                            cursorY = margin;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(24);
                            pdf.setTextColor(118, 75, 162);
                            pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                            cursorY += 20;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(10);
                            pdf.setTextColor(74, 85, 104);
                        }
                        pdf.text(line, contentX + 8, contentY);
                        contentY += listItemHeight;
                    });
                });
                contentY += sectionSpacing;

                pdf.setFontSize(12);
                pdf.setTextColor(74, 85, 104);
                pdf.text("Instructions:", contentX, contentY);
                contentY += subtitleHeight;
                pdf.setFontSize(10);
                const instructions = recipe.instructions.split('. ').filter(s => s.trim());
                instructions.forEach((instruction, instIndex) => {
                    const instructionText = `${instIndex + 1}. ${instruction.trim()}${instruction.endsWith('.') ? '' : '.'}`;
                    const lines = pdf.splitTextToSize(instructionText, currentContentWidth - 8);
                    lines.forEach(line => {
                        if (contentY + listItemHeight + margin > pageHeight) {
                            pdf.addPage();
                            cursorY = margin;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(24);
                            pdf.setTextColor(118, 75, 162);
                            pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                            cursorY += 20;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(10);
                            pdf.setTextColor(74, 85, 104);
                        }
                        pdf.text(line, contentX + 8, contentY);
                        contentY += listItemHeight;
                    });
                });
                contentY += sectionSpacing + 5;

                pdf.setDrawColor(226, 232, 240);
                pdf.roundedRect(x, cardStartY, width, contentY - cardStartY, 2, 2, 'S');
                cursorY = contentY;
            });

            pdf.save('vegan-recipes.pdf');
        }

        function restart() {
            currentStep = 1;
            userData = {};
            nutritionPlan = {};
            mealPlan = {};
            shoppingList = {};
            recipes = {};
            preliminaryMealChoices = {};
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if(el.type === 'checkbox') el.checked = false;
                else if (el.type === 'range') {
                    if (el.id === 'bodyFat') el.value = 20;
                    if (el.id === 'dailyCaloriesBurned') el.value = 2000;
                }
                else el.value = '';
            });
            document.getElementById('bodyFatValue').innerText = document.getElementById('bodyFat').value + '%';
            document.getElementById('dailyCaloriesBurnedValue').innerText = document.getElementById('dailyCaloriesBurned').value + ' kcal';

            const aggressiveOption = document.getElementById('aggressiveOption');
            aggressiveOption.disabled = false;
            aggressiveOption.style.display = 'block';
            document.getElementById('aggressiveWarning').classList.add('hidden');
            showStep(1);
        }

        window.openInfoModal = function() {
            document.getElementById('infoModal').classList.remove('hidden');
        }

        window.closeInfoModal = function() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        window.openAdvantagesModal = function() {
            document.getElementById('advantagesModal').classList.remove('hidden');
        }

        window.closeAdvantagesModal = function() {
            document.getElementById('advantagesModal').classList.add('hidden');
        }

        window.openB12Modal = function() {
            document.getElementById('b12Modal').classList.remove('hidden');
        }

        window.closeB12Modal = function() {
            document.getElementById('b12Modal').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            showStep(1);
            document.getElementById('bodyFat').value = 20;
            document.getElementById('bodyFatValue').innerText = document.getElementById('bodyFat').value + '%';
            document.getElementById('dailyCaloriesBurned').value = 2000;
            document.getElementById('dailyCaloriesBurnedValue').innerText = document.getElementById('dailyCaloriesBurned').value + ' kcal';

            document.getElementById('bodyFat').addEventListener('change', toggleWeightLossRate);
            document.getElementById('goal').addEventListener('change', toggleWeightLossRate);

            document.getElementById('nextBtnStep1').addEventListener('click', nextStep);
            document.getElementById('prevBtnStep2').addEventListener('click', prevStep);
            document.getElementById('nextBtnStep2').addEventListener('click', nextStep);
            document.getElementById('prevBtnStep3').addEventListener('click', prevStep);
            document.getElementById('prevBtnStep4').addEventListener('click', prevStep);
            document.getElementById('prevBtnStep7').addEventListener('click', prevStep);
            document.getElementById('prevBtnStep8').addEventListener('click', prevStep);
            document.getElementById('prevBtnStep9').addEventListener('click', prevStep);
            document.getElementById('prevBtnStep10').addEventListener('click', prevStep);
        });

        function formatShoppingListItem(item) {
            const { name, quantity, unit } = item;
            const capName = name.charAt(0).toUpperCase() + name.slice(1);

            if ((name.includes('milk') || name.includes('broth')) && unit === 'ml' && quantity >= 1000) {
                const liters = quantity / 1000;
                const cartons = Math.ceil(liters); 
                return `${capName} (${cartons} x 1L carton${cartons > 1 ? 's' : ''}, ${Math.ceil(quantity)}ml total)`;
            }
            if (name.includes('avocado') && unit === 'g') {
                const count = Math.round(quantity / 150);
                return `${capName} (${count} piece${count !== 1 ? 's' : ''})`;
            }
            if (name.includes('tofu') && unit === 'g') {
                const count = Math.round(quantity / 300);
                return `${capName} (${count} block${count !== 1 ? 's' : ''})`;
            }
            if (name.includes('tempeh') && unit === 'g') {
                const count = Math.round(quantity / 200);
                return `${capName} (${count} block${count !== 1 ? 's' : ''})`;
            }
            if (unit === 'g' && quantity >= 1000) {
                return `${capName} (${(quantity / 1000).toFixed(1)}kg)`;
            }
            if (unit === 'ml' && quantity >= 1000) {
                return `${capName} (${(quantity / 1000).toFixed(1)}L)`;
            }
            return `${capName} (${Math.ceil(quantity)}${unit})`;
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegan Meal Prep Planner</title>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        h3 {
            color: #4a5568;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }
        
        h4 {
            color: #5a67d8; /* A slightly different shade for sub-headings within cards */
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 25px rgba(113, 128, 150, 0.3);
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .nutrition-summary {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .macro-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .macro-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .meal-plan {
            margin-top: 20px;
        }

        .day-card {
            background: white;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .day-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .meals {
            padding: 20px;
        }

        .meal {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .meal-type {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .meal-item {
            margin-bottom: 5px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .hidden {
            display: none !important;
        }

        .warning {
            background: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.5em;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .macro-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Shopping List Styles --- */
        .shopping-list .category-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2d3748;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #edf2f7;
            text-align: left; /* Align to left to match normal text flow */
        }

        .shopping-list .item-list {
            list-style: none; /* Remove default list bullets */
            padding: 0;
            margin: 0;
        }

        .shopping-list .shopping-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 1.05em;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .shopping-list .shopping-item:hover {
            background: #edf2f7;
            border-color: #667eea;
        }

        .shopping-list .shopping-item::before {
            content: '□ '; /* Checkbox character */
            margin-right: 10px;
            color: #667eea;
            font-weight: bold;
        }

        /* --- Recipe Styles --- */
        .recipe-section {
            margin-top: 20px;
        }

        .recipe-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .recipe-card .recipe-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .recipe-card .recipe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            color: #718096;
            font-weight: 500;
        }

        .recipe-card ul.ingredients-list,
        .recipe-card ol.instructions-list {
            list-style-position: inside; /* Puts bullets/numbers inside padding */
            padding-left: 20px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a5568;
            line-height: 1.6;
        }

        .recipe-card ul.ingredients-list li,
        .recipe-card ol.instructions-list li {
            margin-bottom: 5px;
        }
        
        .recipe-card ul.ingredients-list {
            list-style-type: disc; /* Standard bullet points */
        }
        
        .recipe-card ol.instructions-list {
            list-style-type: decimal; /* Numbered list for steps */
        }
        
        /* Styles for the PDF rendering container */
        #pdf-render-area {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .pdf-page {
            width: 210mm; /* A4 width */
            min-height: 280mm; /* A4 height with margin */
            padding: 15mm;
            box-sizing: border-box;
            background-color: #ffffff;
            page-break-after: always;
        }

        .pdf-page:last-child {
            page-break-after: auto;
        }
        
        .pdf-h1 {
            font-size: 24pt;
            font-weight: bold;
            color: #764ba2;
            text-align: center;
            margin-bottom: 12mm;
        }
        .pdf-h2 {
            font-size: 16pt;
            font-weight: 600;
            color: #667eea;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 3mm;
            margin-top: 10mm;
            margin-bottom: 5mm;
        }
        
        /* Table for Meal Plan */
        .pdf-meal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
        }
        .pdf-meal-table th, .pdf-meal-table td {
            border: 1px solid #eadef7; /* Pastel border */
            padding: 3mm;
            text-align: left;
            vertical-align: top;
        }
        .pdf-meal-table th {
            font-weight: 600;
            background-color: #f3eefc; /* Soft Lavender */
        }
        .pdf-meal-table ul {
            padding-left: 5mm;
            margin: 0;
        }
        .pdf-meal-table tr:nth-child(even) {
            background-color: #f8f7fc;
        }

        /* Shopping List */
        .pdf-shopping-list {
            column-count: 2;
            column-gap: 15mm;
        }
        .pdf-shopping-list .category {
            break-inside: avoid-column;
            margin-bottom: 8mm;
        }
        .pdf-shopping-list .pdf-category-title {
            font-size: 12pt;
            font-weight: bold;
            background-color: #eef9fc; /* Soft Blue */
            padding: 3mm;
            border-radius: 5px;
            display: inline-block;
            width: 100%;
        }
         .pdf-shopping-list .item-list {
            list-style: none;
            padding: 0;
            margin-top: 3mm;
        }
        .pdf-shopping-list .shopping-item {
            padding: 2mm;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10pt;
        }
        .pdf-shopping-list .shopping-item::before {
             content: '☐';
             margin-right: 3mm;
             color: #667eea;
        }

        /* Recipes */
        .pdf-recipe-card {
            break-inside: avoid;
            margin-bottom: 8mm;
            padding: 7mm;
            border-radius: 5px;
            background-color: #fff9f5; /* Soft Peach */
            border: 1px solid #ffede3;
        }
        .pdf-recipe-card .pdf-recipe-title {
             font-size: 16pt;
             font-weight: bold;
             color: #764ba2;
             margin-bottom: 4mm;
        }
         .pdf-recipe-card .pdf-recipe-info {
             font-size: 10pt;
             color: #718096;
             margin-bottom: 5mm;
         }
         .pdf-recipe-card .pdf-recipe-info span {
             margin-right: 5mm;
         }
         .pdf-recipe-card .pdf-recipe-subtitle {
             font-size: 12pt;
             font-weight: 600;
             color: #667eea;
             margin-top: 5mm;
             margin-bottom: 2mm;
             border-bottom: 1px solid #eadef7;
             padding-bottom: 1mm;
        }
        .pdf-recipe-card ul, .pdf-recipe-card ol {
            padding-left: 5mm;
            font-size: 10pt;
            line-height: 1.5;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto; /* Allow scrolling for modal content */
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh; /* Max height to fit viewport */
            overflow-y: auto; /* Enable scrolling within modal content */
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #667eea;
            font-weight: bold;
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: #764ba2;
        }

        .modal-content h3 {
            color: #2d3748;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .modal-content p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .modal-content ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .modal-content li {
            margin-bottom: 5px;
        }

        .modal-content a {
            color: #667eea;
            text-decoration: none;
        }

        .modal-content a:hover {
            text-decoration: underline;
        }

        .disclaimer {
            background-color: #fffbeb; /* Light yellow background */
            border-left: 5px solid #ecc94b; /* Yellow border */
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #6b4615; /* Darker text for contrast */
            font-size: 0.95em;
        }

        /* New section styles for comparative benefits */
        .benefits-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #e2e8f0;
        }
        .benefits-section h3 {
            text-align: center;
            font-size: 1.6em;
            color: #5a67d8;
            margin-bottom: 20px;
        }
        .benefits-section h4 {
            font-size: 1.2em;
            color: #4a5568;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid #edf2f7;
            padding-bottom: 5px;
        }
        .benefits-section ul {
            list-style-type: none;
            padding-left: 0;
        }
        .benefits-section li {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #4a5568;
            border-left: 3px solid #667eea;
        }
        .benefits-section .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .benefits-section .comparison-item {
            background: #eef9fc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #a0d9e7;
        }
        .benefits-section .comparison-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .benefits-section .comparison-label {
            font-size: 1em;
            color: #333;
        }
        .benefits-section .comparison-text {
            font-size: 0.9em;
            color: #718096;
            margin-top: 10px;
        }
        .b12-disclaimer {
            background-color: #ffffee; /* Light pastel yellow */
            border-left: 5px solid #ffd700; /* Gold-like border */
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            color: #8B8000; /* Darker text for contrast */
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .b12-disclaimer button {
            background-color: #ffd700;
            color: #6b4615;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        .b12-disclaimer button:hover {
            background-color: #ffc107;
        }

        /* B12 Modal Styles (similar to other modals) */
        #b12Modal .modal-content {
            max-width: 600px;
        }
    </style>
</head>
<body>
    <!-- This hidden div is used as a staging area for generating the clean PDF layout -->
    <div id="pdf-render-area" style="position: absolute; left: -9999px; top: 0; background: white;"></div>

    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 16.67%"></div>
        </div>

        <div class="step active" id="step1">
            <div class="card">
                <h1>🌱 Vegan Meal Prep Planner</h1>
                <h2>Personal Details</h2>
                
                <div class="disclaimer">
                    <strong>Disclaimer:</strong> This website provides meal plan estimations based on general nutritional science. These calculations are for informational purposes only and are not a substitute for professional medical or dietary advice. Individual results may vary. Consult with a healthcare professional or registered dietitian before making any significant changes to your diet or lifestyle.
                </div>

                <div class="form-group">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" step="0.1" required>
                </div>

                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" required>
                </div>

                <!-- New optional fields for estimation -->
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" min="15" max="100" value="25" required>
                </div>

                <div class="form-group">
                    <label for="activityLevel">Activity Level</label>
                    <select id="activityLevel">
                        <option value="sedentary">Sedentary (little or no exercise)</option>
                        <option value="lightly_active">Lightly Active (light exercise/sports 1-3 days/week)</option>
                        <option value="moderately_active">Moderately Active (moderate exercise/sports 3-5 days/week)</option>
                        <option value="very_active">Very Active (hard exercise/sports 6-7 days a week)</option>
                        <option value="extremely_active">Extremely Active (hard daily exercise/sports & physical job or 2x training)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bodyType">Body Type (for estimation if not provided)</label>
                    <select id="bodyType">
                        <option value="average">Average/Mesomorph</option>
                        <option value="lean">Lean/Ectomorph</option>
                        <option value="stocky">Stocky/Endomorph</option>
                    </select>
                </div>
                <!-- End new optional fields -->

                <div class="form-group">
                    <label for="bodyFat">Body Fat Percentage (%) (Optional - estimated if left blank)</label>
                    <input type="number" id="bodyFat" step="0.1" min="5" max="50" placeholder="e.g. 20 (estimated if blank)">
                </div>

                <div class="form-group">
                    <label for="muscleMass">Muscle Mass (kg) (Optional - estimated if left blank)</label>
                    <input type="number" id="muscleMass" step="0.1" placeholder="e.g. 45 (estimated if blank)">
                </div>

                <div class="form-group">
                    <label for="dailyCaloriesBurned">Total Daily Calories Burned (Optional - estimated if left blank)</label>
                    <input type="number" id="dailyCaloriesBurned" placeholder="e.g. 2000 (estimated if blank)">
                </div>

                <div class="button-group">
                    <button class="btn" onclick="nextStep()">Next</button>
                    <button class="btn btn-secondary" onclick="openInfoModal()">Learn More about Calculations</button>
                    <button class="btn btn-secondary" onclick="openAdvantagesModal()">Advantages of a Vegan Diet</button>
                </div>
            </div>
        </div>

        <div class="step" id="step2">
            <div class="card">
                <h2>Your Goals</h2>
                
                <div class="form-group">
                    <label for="goal">Primary Goal</label>
                    <select id="goal" onchange="toggleWeightLossRate()">
                        <option value="maintain">Maintain Weight</option>
                        <option value="lose">Lose Fat</option>
                        <option value="gain">Gain Muscle</option>
                        <option value="recomp">Recomposition (Gain Muscle + Lose Fat)</option>
                        <option value="gain_weight">Gain Weight (Low BMI)</option>
                    </select>
                </div>

                <div class="form-group hidden" id="weightLossGroup">
                    <label for="weightLossRate">Weight Loss Rate</label>
                    <select id="weightLossRate">
                        <option value="0.5">0.5 kg/week</option>
                        <option value="1">1 kg/week</option>
                        <option value="1.5" id="aggressiveOption">1.5 kg/week</option>
                    </select>
                    <div class="warning hidden" id="aggressiveWarning">
                        1.5 kg/week option is only available for body fat percentages above 35%
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
        </div>

        <div class="step" id="step3">
            <div class="card">
                <h2>Food Preferences & Allergies</h2>
                <p style="margin-bottom: 20px; color: #718096;">Select any foods you'd like to exclude from your meal plan:</p>
                
                <div class="checkbox-group" id="foodExclusions">
                    <div class="checkbox-item">
                        <input type="checkbox" id="gluten" value="gluten">
                        <label for="gluten">Gluten</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="nuts" value="nuts">
                        <label for="nuts">Tree Nuts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="peanuts" value="peanuts">
                        <label for="peanuts">Peanuts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="soy" value="soy">
                        <label for="soy">Soy</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="seeds" value="seeds">
                        <label for="seeds">Seeds</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="coconut" value="coconut">
                        <label for="coconut">Coconut</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mushrooms" value="mushrooms">
                        <label for="mushrooms">Mushrooms</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="legumes" value="legumes">
                        <label for="legumes">Legumes</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="milkPreference">Preferred Plant Milk Type</label>
                    <select id="milkPreference">
                        <option value="any">Any / No Preference</option>
                        <option value="almond">Almond Milk</option>
                        <option value="soy">Soy Milk</option>
                        <option value="oat">Oat Milk</option>
                        <option value="coconut">Coconut Milk</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn" onclick="calculateNutrition()">Calculate Plan</button>
                </div>
            </div>
        </div>

        <div class="step" id="step4">
            <div class="card">
                <h2>Your Nutritional Plan</h2>
                
                <div class="nutrition-summary" id="nutritionSummary">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn" onclick="nextStep()">Continue to Meal Preferences</button>
                </div>
            </div>
        </div>

        <div class="step" id="step5">
            <div class="card">
                <h2>Meal Preferences</h2>
                
                <div class="form-group">
                    <label for="cookingFreq">Cooking Frequency Preference</label>
                    <select id="cookingFreq">
                        <option value="batch">Batch cooking (cook once, eat multiple times)</option>
                        <option value="fresh">Fresh cooking (different meals each time)</option>
                        <option value="mixed">Mixed approach</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="variety">Desired Meal Variety</label>
                    <select id="variety">
                        <option value="low">Low (simple, repeated meals)</option>
                        <option value="medium">Medium (some variety)</option>
                        <option value="high">High (maximum variety)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="numWeeks">Number of Weeks for Meal Plan</label>
                    <select id="numWeeks">
                        <option value="1">1 Week</option>
                        <option value="2">2 Weeks</option>
                        <option value="3">3 Weeks</option>
                        <option value="4">4 Weeks</option>
                    </select>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="substitutePreference">Include Ready-to-Go Vegan Substitutes?</label>
                    <select id="substitutePreference">
                        <option value="none">None (prefer whole foods)</option>
                        <option value="some">Some (generic vegan patties, sausages)</option>
                        <option value="all">All (includes branded like Beyond, Impossible)</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn" onclick="generateMealPlan()">Generate Meal Plan</button>
                </div>
            </div>
        </div>

        <div class="step" id="loading">
            <div class="card">
                <div class="loading">
                    <div class="spinner"></div>
                    <h2>Generating Your Personalized Meal Plan...</h2>
                    <p>Creating nutritionally balanced vegan meals just for you!</p>
                </div>
            </div>
        </div>

        <div class="step" id="step6">
            <div class="card">
                <h2>Your 7-Day Vegan Meal Plan</h2>
                
                <div id="mealPlanResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn" onclick="showShoppingList()">View Shopping List</button>
                    <button class="btn" onclick="downloadPlan()">Download PDF</button>
                </div>
            </div>
        </div>

        <div class="step" id="step7">
            <div class="card">
                <h2>Shopping List</h2>
                
                <div id="shoppingListResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back to Meal Plan</button>
                    <button class="btn" onclick="showRecipes()">View Recipes</button>
                    <button class="btn" onclick="downloadShoppingList()">Download List</button>
                </div>
            </div>
        </div>

        <div class="step" id="step8">
            <div class="card">
                <h2>Meal Prep & Recipe Guide</h2>
                
                <div id="recipeResults">
                    </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showShoppingList()">Back to Shopping List</button>
                    <button class="btn" onclick="showBenefits()">View Impact Summary</button>
                    <button class="btn" onclick="downloadRecipes()">Download Recipes</button>
                    <button class="btn" onclick="restart()">Start Over</button>
                </div>
            </div>
        </div>
        
        <!-- New Step for Comparative Benefits -->
        <div class="step" id="step9">
            <div class="card">
                <div id="comparativeBenefitsSection" class="benefits-section">
                    <h3>Impact of Your Vegan Diet</h3>

                    <h4>Animal Lives Saved</h4>
                    <ul>
                        <li id="animalsSavedWeek"></li>
                        <li id="animalsSavedYear"></li>
                    </ul>

                    <h4>Environmental Impact Saved</h4>
                    <ul>
                        <li id="landSaved"></li>
                        <li id="co2Saved"></li>
                        <li id="waterSaved"></li>
                    </ul>

                    <div class="b12-disclaimer">
                        <p><strong>Important Note on Vitamin B12:</strong> As a vegan, ensuring adequate Vitamin B12 intake is crucial. The recommended daily intake for adults is 2.4 micrograms (mcg). It is highly recommended to supplement with B12 or consume B12-fortified foods regularly.</p>
                        <button onclick="openB12Modal()">Learn more about B12</button>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showRecipesBack()">Back to Recipes</button>
                    <button class="btn" onclick="showMealPlan()">Back to Meal Plan</button>
                    <button class="btn" onclick="restart()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeInfoModal()">✖</button>
            <h2>How Calculations Are Made</h2>
            <p>The calculations used in this planner provide estimations based on widely accepted formulas in nutritional science. It's important to remember these are approximations, and individual needs can vary.</p>

            <h3>Basal Metabolic Rate (BMR) & Total Daily Energy Expenditure (TDEE)</h3>
            <p>Your Basal Metabolic Rate (BMR) is the number of calories your body needs to perform basic, life-sustaining functions when at rest. Your Total Daily Energy Expenditure (TDEE) is an estimate of how many calories you burn per day, including physical activity.</p>
            <p>We use a variation of the Mifflin-St Jeor equation for BMR, which is then multiplied by an activity factor to estimate TDEE. For reference:</p>
            <ul>
                <li><a href="https://pubmed.ncbi.nlm.nih.gov/2305711/" target="_blank">A new predictive equation for resting energy expenditure in healthy individuals (Mifflin, St Jeor, 1990)</a></li>
                <li><a href="https://www.researchgate.net/publication/384950082_Comprehensive_Review_on_BMI_TDEE_BMR_and_Calories_for_Weight_Management: Insights into Energy Expenditure and Nutrient Balance for Long-Term Well-Being" target="_blank">Comprehensive Review on BMI, TDEE, BMR, and Calories for Weight Management (ResearchGate)</a></li>
            </ul>

            <h3>Body Fat Percentage Estimation</h3>
            <p>If not provided directly, body fat percentage is estimated based on reported gender and selected body type (lean/ectomorph, average/mesomorph, stocky/endomorph). These are very general approximations. For more precise measurements, consider methods like DEXA scans or bioelectrical impedance analysis.</p>
            <ul>
                <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2769821/" target="_blank">Body Composition Methods: Comparisons and Interpretation (PubMed Central)</a></li>
                <li><a href="https://www.annfammed.org/content/early/2025/06/23/afm.240330" target="_blank" >Body Mass Index vs Body Fat Percentage as a Predictor of Mortality in Adults Aged 20-49 Years (Annals of Family Medicine)</a></li>
            </ul>

            <h3>Muscle Mass Estimation</h3>
            <p>Muscle mass, when not directly provided, is estimated as a percentage of your lean body mass (total weight minus fat mass). This is a simplified approach, as precise muscle mass measurement typically requires advanced imaging techniques.</p>
            <ul>
                <li><a href="https://www.mdpi.com/2072-6643/12/3/755" target="_blank">Reference Values for Skeletal Muscle Mass – Current Concepts and Methodological Considerations (MDPI)</a></li>
                <li><a href="https://www.researchgate.net/publication/378657737_Skeletal_muscle_estimation: A review of techniques and their applications" target="_blank">Skeletal muscle estimation: A review of techniques and their applications (ResearchGate)</a></li>
            </ul>
        </div>
    </div>

    <!-- Advantages of Vegan Diet Modal -->
    <div id="advantagesModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeAdvantagesModal()">✖</button>
            <h2>Advantages of a Vegan Diet</h2>
            <p>A well-planned vegan diet can offer numerous benefits for your health, for animals, and for the environment.</p>

            <h3>For Your Health</h3>
            <p>Vegan diets are typically rich in fiber, vitamins, and minerals, and lower in saturated fat and cholesterol. This can contribute to a reduced risk of various chronic diseases.</p>
            <ul>
                <li><a href="https://www.frontiersin.org/journals/nutrition/articles/10.3389/fnut.2023.1294497/full" target="_blank">Frontiers in Nutrition: Effect of plant-based dietary patterns on cardiometabolic health: a systematic review and meta-analysis of randomized controlled trials (2023)</a></li>
                <li><a href="https://www.hopkinsmedicine.org/health/wellness-and-prevention/how-to-maintain-a-balanced-diet-as-a-vegetarian-or-vegan" target="_blank">Johns Hopkins Medicine: How to Maintain a Balanced Diet as a Vegetarian or Vegan</a></li>
                <li><a href="https://www.rush.edu/news/health-benefits-vegan-diet" target="_blank">Rush University Medical Center: The Health Benefits of a Vegan Diet</a></li>
                <li><a href="https://www.nhs.uk/live-well/eat-well/how-to-eat-a-balanced-diet/the-vegan-diet/" target="_blank">NHS: The vegan diet</a></li>
                <li><a href="https://www.health.harvard.edu/heart-health/more-evidence-that-plant-based-diets-might-ward-off-heart-problems" target="_blank">Harvard Health Publishing: More evidence that plant-based diets might ward off heart problems</a></li>
                <li><a href="https://nutritionj.biomedcentral.com/articles/10.1186/s12937-023-00877-2" target="_blank">Nutrition Journal: Vegan diet and metabolic health in adolescents: a narrative review (2023)</a></li>
                <li><a href="https://www.who.int/news-room/questions-and-answers/item/cancer-carcinogenicity-of-the-consumption-of-red-meat-and-processed-meat" target="_blank">WHO: Cancer: Carcinogenicity of the consumption of red meat and processed meat</a></li>
            </ul>

            <h3>For the Animals</h3>
            <p>Choosing a vegan diet is a direct way to avoid supporting industrial animal agriculture, which is often associated with animal suffering and exploitation. It aligns with ethical considerations regarding animal sentience and the right to live free from human-imposed harm.</p>
            <p>For a deeper understanding of animal agriculture and its ethical implications, consider watching these documentaries or visiting these informative websites:</p>
            <ul>
                <li><strong>Dominion:</strong> A powerful documentary exposing the realities of animal agriculture. Free to watch at <a href="https://www.dominionmovement.com/watch" target="_blank">dominionmovement.com/watch</a></li>
                <li><strong>Okja:</strong> A fictional film with a strong message about animal rights and the food industry, available on Netflix.</li>
                <li><strong>Cowspiracy:</strong> Explores the environmental impact of animal agriculture. Available on Netflix.</li>
                <li><strong>The Game Changers:</strong> Focuses on plant-based diets for elite athletes. Available on Netflix.</li>
                <li><strong>Challenge 22:</strong> Offers a free, 22-day vegan challenge with mentorship and recipes. Visit <a href="https://challenge22.com/" target="_blank">challenge22.com</a></li>
                <li><strong>The Vegan Society:</strong> Provides extensive information and resources on veganism. Visit <a href="https://www.vegansociety.com/" target="_blank">vegansociety.com</a></li>
            </ul>

            <h3>For the Environment</h3>
            <p>Animal agriculture is a significant contributor to greenhouse gas emissions, deforestation, water pollution, and biodiversity loss. A shift towards plant-based diets can substantially reduce your environmental footprint.</p>
            <ul>
                <li><a href="https://www.ingredion.com/na/en-us/be-whats-next/plant-based-eating-living-for-sustainable-future.html" target="_blank">Ingredion: Plant-Based Eating & Living for a Sustainable Future</a></li>
                <li><a href="https://www.vegansociety.com/news/media/statistics/environment-and-sustainability" target="_blank">The Vegan Society: Environment & Sustainability Statistics</a></li>
                <li><a href="https://cafegratitude.com/blogs/news/happy-earth-month-how-eating-plant-based-can-have-a-positive-impact-on-the-environment" target="_blank">Cafe Gratitude: Happy Earth Month: How Eating Plant-Based Can Have A Positive Impact On The Environment</a></li>
                <li><a href="https://veganoutreach.org/environment/" target="_blank">Vegan Outreach: Environmental Benefits of a Vegan Diet</a></li>
                <li><a href="https://www.theguardian.com/environment/2023/jul/20/vegan-diet-cuts-environmental-damage-climate-heating-emissions-study" target="_blank">The Guardian: Vegan diet ‘cuts environmental damage’ more than other meat-free living, study finds</a></li>
                <li><a href="https://www.vegansociety.com/go-vegan/why-go-vegan" target="_blank">The Vegan Society: Why Go Vegan?</a></li>
                <li>Poore, J., & Nemecek, T. (2018). Reducing food’s environmental impacts through producers and consumers. <a href="https://www.science.org/doi/10.1126/science.aaq0216" target="_blank"><em>Science</em>, 360(6392), 987-992.</a></li>
            </ul>
        </div>
    </div>

    <!-- B12 Info Modal -->
    <div id="b12Modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeB12Modal()">✖</button>
            <h2>Understanding Vitamin B12</h2>
            <p>Vitamin B12 (cobalamin) is an essential nutrient required for red blood cell formation, neurological function, and DNA synthesis. Unlike other vitamins, B12 is not produced by plants or animals themselves. It is synthesized by certain bacteria.</p>
            <p>Historically, humans obtained B12 from bacteria in soil and unwashed foods. However, modern sanitation practices have largely removed these sources from our diets.</p>
            <p>Farm animals, particularly those raised in intensive systems, often do not get enough B12 from their feed alone due to modern farming methods and sterile environments. As a result, B12 supplements are commonly added to animal feed to ensure their health and to enrich the meat, dairy, and eggs produced for human consumption.</p>
            <p>Therefore, whether you eat animal products or not, many people are effectively consuming B12 that was produced by bacteria and then supplemented. Vegans directly supplement with B12, making it a reliable and ethical source.</p>
            <h3>Scientific References:</h3>
            <ul>
                <li><a href="https://www.mdpi.com/2674-0311/3/2/10" target="_blank">MDPI: Vitamin B12 in Vegan Diets: A Critical Review and Practice Guide (2023)</a></li>
            </ul>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // JavaScript Logic
        let currentStep = 1;
        let userData = {};
        let nutritionPlan = {};
        let mealPlan = {}; // This will now store multiple weeks, e.g., { 'Week 1': {day: {meals}}, 'Week 2': {...} }
        let shoppingList = {};
        let recipes = {}; // This will now store unique recipes chosen across all weeks

        const totalSteps = 9; // Updated to 9 steps (excluding loading, so 10 total states)

        function updateProgress() {
            const progressPercent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step
            let stepId;
            if (stepNumber === 6) { // This is the loading step
                stepId = 'loading';
            } else if (stepNumber === 7) { // This is actual step 6 in terms of content
                stepId = 'step6';
            } else if (stepNumber === 8) { // This is actual step 7 in terms of content
                stepId = 'step7';
            } else if (stepNumber === 9) { // This is actual step 8 (Recipes) in terms of content
                stepId = 'step8';
            } else if (stepNumber === 10) { // This is actual step 9 (Benefits) in terms of content
                stepId = 'step9';
            }
            else { // For steps 1, 2, 3, 4, 5
                stepId = `step${stepNumber}`;
            }
            
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
            }
            
            currentStep = stepNumber;
            updateProgress();
        }

        function nextStep() {
            if (validateCurrentStep()) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function validateCurrentStep() {
            // Weight and Height are still required for base calculations
            const weight = document.getElementById('weight').value;
            const height = document.getElementById('height').value;
            const age = document.getElementById('age').value; // Age is now required for estimation

            if (!weight || !height || !age) {
                alert('Please fill in Weight, Height, and Age. Other fields are optional.');
                return false;
            }
            
            userData.weight = parseFloat(weight);
            userData.height = parseFloat(height);
            userData.age = parseInt(age); // Store age
            userData.gender = document.getElementById('gender').value; // Store gender
            userData.activityLevel = document.getElementById('activityLevel').value; // Store activity level
            userData.bodyType = document.getElementById('bodyType').value; // Store body type
            userData.milkPreference = document.getElementById('milkPreference').value; // Store milk preference
            // Make sure numWeeks is set if it's step 5, default to 1 if not defined yet
            userData.numWeeks = document.getElementById('numWeeks') ? parseInt(document.getElementById('numWeeks').value) : 1; 
            userData.substitutePreference = document.getElementById('substitutePreference') ? document.getElementById('substitutePreference').value : 'none'; // Store substitute preference, default to 'none' if element not present yet

            // Body Fat, Muscle Mass, Daily Calories are now optional at input stage
            userData.bodyFat = parseFloat(document.getElementById('bodyFat').value) || 0; // Will be estimated if 0
            userData.muscleMass = parseFloat(document.getElementById('muscleMass').value) || 0; // Will be estimated if 0
            userData.dailyCaloriesBurned = parseFloat(document.getElementById('dailyCaloriesBurned').value) || 0; // Will be estimated if 0

            // Specific validation for "Gain Weight (Low BMI)" goal
            if (currentStep === 2) {
                const goal = document.getElementById('goal').value;
                userData.goal = goal; // Capture the goal here!
                if (goal === 'gain_weight') {
                    const height_m = userData.height / 100;
                    const bmi = userData.weight / (height_m * height_m);
                    if (bmi >= 18.5) { // Assuming 18.5 is the threshold for underweight
                        alert('The "Gain Weight (Low BMI)" option is intended for individuals with a BMI below 18.5. Please choose another goal or provide different body metrics.');
                        return false;
                    }
                }
            }

            return true;
        }

        function toggleWeightLossRate() {
            const goal = document.getElementById('goal').value;
            const weightLossGroup = document.getElementById('weightLossGroup');
            const aggressiveOption = document.getElementById('aggressiveOption');
            const aggressiveWarning = document.getElementById('aggressiveWarning');
            
            if (goal === 'lose' || goal === 'recomp') {
                weightLossGroup.classList.remove('hidden');
                
                // Use the collected userData.bodyFat, which might be an estimate
                const bodyFat = userData.bodyFat || 20; // Fallback if still not set or estimated
                if (bodyFat <= 35) {
                    aggressiveOption.disabled = true;
                    aggressiveOption.style.display = 'none';
                    aggressiveWarning.classList.remove('hidden');
                } else {
                    aggressiveOption.disabled = false;
                    aggressiveOption.style.display = 'block';
                    aggressiveWarning.classList.add('hidden');
                }
            } else {
                weightLossGroup.classList.add('hidden');
            }
        }

        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else { // female
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }

        function estimateTDEE(weight, height, age, gender, activityLevel) {
            const bmr = calculateBMR(weight, height, age, gender);
            const activityFactors = {
                'sedentary': 1.2,
                'lightly_active': 1.375,
                'moderately_active': 1.55,
                'very_active': 1.725,
                'extremely_active': 1.9
            };
            return bmr * activityFactors[activityLevel];
        }

        function estimateBodyFatPercentage(gender, bodyType) {
            // Very rough estimates based on general body types
            if (gender === 'male') {
                switch (bodyType) {
                    case 'lean': return 12; // Ectomorph
                    case 'average': return 18; // Mesomorph
                    case 'stocky': return 25; // Endomorph
                }
            } else { // female
                switch (bodyType) {
                    case 'lean': return 22; // Ectomorph
                    case 'average': return 28; // Mesomorph
                    case 'stocky': return 35; // Endomorph
                }
            }
            return 20; // Default fallback
        }

        function estimateMuscleMass(weight, bodyFat) {
            // Muscle mass is a portion of Lean Body Mass (LBM)
            const leanBodyMass = weight * (1 - (bodyFat / 100));
            // Skeletal muscle typically accounts for 60-70% of LBM
            return leanBodyMass * 0.65; // Use 65% as a general estimate
        }

        function calculateNutrition() {
            if (!validateCurrentStep()) return;

            // If dailyCaloriesBurned is not provided, estimate it
            if (userData.dailyCaloriesBurned === 0) {
                userData.dailyCaloriesBurned = estimateTDEE(
                    userData.weight,
                    userData.height,
                    userData.age,
                    userData.gender,
                    userData.activityLevel
                );
            }

            // If bodyFat is not provided, estimate it
            if (userData.bodyFat === 0) {
                userData.bodyFat = estimateBodyFatPercentage(
                    userData.gender,
                    userData.bodyType
                );
            }

            // If muscleMass is not provided, estimate it
            if (userData.muscleMass === 0) {
                userData.muscleMass = estimateMuscleMass(
                    userData.weight,
                    userData.bodyFat
                );
            }
            
            let targetCalories = userData.dailyCaloriesBurned;
            let deficit = 0;
            
            switch(userData.goal) {
                case 'lose':
                    deficit = userData.weightLossRate * 7700 / 7;
                    targetCalories = userData.dailyCaloriesBurned - deficit;
                    break;
                case 'gain':
                    targetCalories = userData.dailyCaloriesBurned + 300; // Caloric surplus for muscle gain
                    break;
                case 'recomp':
                    deficit = (userData.weightLossRate * 7700 / 7) * 0.5;
                    targetCalories = userData.dailyCaloriesBurned - deficit;
                    break;
                case 'gain_weight':
                    targetCalories = userData.dailyCaloriesBurned + 500; // Caloric surplus for general weight gain (low BMI)
                    break;
            }
            
            const protein = Math.round(userData.weight * 2.2);
            const proteinCals = protein * 4;
            const fatCals = Math.round(targetCalories * 0.25);
            const fat = Math.round(fatCals / 9);
            const carbCals = targetCalories - proteinCals - fatCals;
            const carbs = Math.round(carbCals / 4);
            
            nutritionPlan = {
                targetCalories: Math.round(targetCalories),
                deficit: Math.round(deficit),
                protein: { grams: protein, calories: proteinCals, percent: Math.round((proteinCals/targetCalories)*100) },
                carbs: { grams: carbs, calories: carbCals, percent: Math.round((carbCals/targetCalories)*100) },
                fat: { grams: fat, calories: fatCals, percent: Math.round((fatCals/targetCalories)*100) },
                vegetables: { grams: 400, recommendation: "5+ servings daily" }
            };
            
            displayNutritionSummary();
            nextStep();
        }

        function displayNutritionSummary() {
            const summary = document.getElementById('nutritionSummary');
            const goalTextMap = { 
                maintain: 'Maintain Current Weight',
                lose: 'Fat Loss',
                gain: 'Muscle Gain',
                recomp: 'Body Recomposition',
                gain_weight: 'Weight Gain'
            };
            
            const userSelectedGoal = userData.goal; 
            let displayGoal = 'Goal Not Selected'; 

            if (userSelectedGoal && goalTextMap[userSelectedGoal]) {
                displayGoal = goalTextMap[userSelectedGoal];
            } else if (userSelectedGoal) {
                displayGoal = userSelectedGoal.charAt(0).toUpperCase() + userSelectedGoal.slice(1);
            }
            

            summary.innerHTML = `
                <h3>Goal: ${displayGoal}</h3>
                <div style="margin: 15px 0;">
                    <strong>Daily Calorie Target: ${nutritionPlan.targetCalories} calories</strong>
                    ${nutritionPlan.deficit > 0 ? `<br><em>Daily Deficit: ${nutritionPlan.deficit} calories</em>` : ''}
                    ${userData.goal === 'gain' ? `<br><em>Daily Surplus: 300 calories</em>` : ''}
                    ${userData.goal === 'gain_weight' ? `<br><em>Daily Surplus: 500 calories</em>` : ''}
                </div>
                <div class="macro-grid">
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.protein.grams}g</div><div>Protein (${nutritionPlan.protein.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.carbs.grams}g</div><div>Carbs (${nutritionPlan.carbs.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">${nutritionPlan.fat.grams}g</div><div>Fat (${nutritionPlan.fat.percent}%)</div></div>
                    <div class="macro-item"><div class="macro-value">400g+</div><div>Vegetables</div></div>
                </div>`;
        }

        function generateMealPlan() {
            if (!validateCurrentStep()) return;
            showStep(6);
            
            setTimeout(() => {
                try {
                    createMealPlan();
                    showStep(7);
                } catch (error) {
                    console.error('Error generating meal plan:', error);
                    alert('There was an error generating your meal plan. Please try again.');
                    showStep(5);
                }
            }, 1500);
        }

        function createMealPlan() {
            console.log('--- createMealPlan() started ---');
            const dailyCals = nutritionPlan.targetCalories;
            const dailyProtein = nutritionPlan.protein.grams;
            const mealStructure = {
                breakfast: { calories: Math.round(dailyCals * 0.25), protein: Math.round(dailyProtein * 0.25) },
                lunch: { calories: Math.round(dailyCals * 0.35), protein: Math.round(dailyProtein * 0.35) },
                dinner: { calories: Math.round(dailyCals * 0.30), protein: Math.round(dailyProtein * 0.30) },
                snacks: { calories: Math.round(dailyCals * 0.10), protein: Math.round(dailyProtein * 0.10) }
            };
            console.log('Meal Structure:', mealStructure);
            
            const numWeeks = userData.numWeeks;
            mealPlan = {}; // Reset mealPlan to store multiple weeks
            recipes = {}; // Reset recipes for cumulative collection
            shoppingList = {}; // Reset shoppingList for cumulative collection

            for (let i = 1; i <= numWeeks; i++) {
                const allVeganMeals = createVeganMealDatabase(); // Re-create/shuffle for each week for more randomization
                const weeklyPlan = generateWeeklyMealPlan(mealStructure, allVeganMeals);
                mealPlan[`Week ${i}`] = weeklyPlan;

                // Collect recipes for each week
                Object.values(weeklyPlan).forEach(day => {
                    Object.values(day).forEach(meal => {
                        if (meal) {
                            // Replace 'plant milk' with specific preference in recipe display if chosen
                            const ingredientsForRecipe = meal.ingredients.map(ing => {
                                if (ing.item === 'plant milk' && userData.milkPreference !== 'any') {
                                    return { ...ing, item: userData.milkPreference + ' milk' };
                                }
                                return ing;
                            });
                            recipes[meal.name] = { ...meal, ingredients: ingredientsForRecipe };
                        }
                    });
                });
            }

            createShoppingList(); // This function now iterates through all weeks in mealPlan
            // createRecipeGuide(allVeganMeals); // This is now done within the loop above to collect unique recipes from all weeks

            displayMealPlan();
            console.log('--- createMealPlan() finished ---');
        }
        
        function createVeganMealDatabase() {
            console.log('--- createVeganMealDatabase() started ---');
            const meals = {
                breakfast: [
                    { name: "Overnight Oats with Berries", calories: 320, protein: 12, cookingTime: "5 mins prep", ingredients: [{item: "oats", quantity: 50, unit: "g"}, {item: "plant milk", quantity: 200, unit: "ml"}, {item: "chia seeds", quantity: 15, unit: "g"}, {item: "mixed berries", quantity: 100, unit: "g"}, {item: "maple syrup", quantity: 10, unit: "ml"}], instructions: 'Combine oats, preferred plant milk, chia seeds, and maple syrup in a jar. Stir well, cover, and refrigerate overnight. In the morning, top with mixed berries.' },
                    { name: "Green Smoothie", calories: 350, protein: 15, cookingTime: "5 mins", ingredients: [{item: "spinach", quantity: 100, unit: "g"}, {item: "banana", quantity: 150, unit: "g"}, {item: "plant protein powder", quantity: 25, unit: "g"}, {item: "plant milk", quantity: 250, unit: "ml"}, {item: "flax seeds", quantity: 10, unit: "g"}], instructions: 'Blend all ingredients until smooth. Serve immediately.' },
                    { name: "Avocado Toast with Tomato", calories: 280, protein: 8, cookingTime: "10 mins", ingredients: [{item: "whole grain bread", quantity: 100, unit: "g"}, {item: "avocado", quantity: 100, unit: "g"}, {item: "cherry tomatoes", quantity: 50, unit: "g"}, {item: "nutritional yeast", quantity: 5, unit: "g"}, {item: "red pepper flakes", quantity: 1, unit: "g"}], instructions: 'Toast bread. Mash avocado and spread on toast. Top with sliced cherry tomatoes, nutritional yeast, and red pepper flakes.' },
                    { name: "Tofu Scramble", calories: 310, protein: 18, cookingTime: "15 mins", ingredients: [{item: "firm tofu", quantity: 200, unit: "g"}, {item: "nutritional yeast", quantity: 10, unit: "g"}, {item: "turmeric", quantity: 2, unit: "g"}, {item: "bell peppers", quantity: 80, unit: "g"}, {item: "onion", quantity: 50, unit: "g"}, {item: "spinach", quantity: 50, unit: "g"}, {item: "whole grain toast", quantity: 50, unit: "g"}], instructions: 'Crumble tofu. Sauté chopped bell peppers and onion. Add tofu, nutritional yeast, turmeric, and spinach. Cook until heated through. Serve with toast.' },
                    { name: "Vegan Breakfast Burrito", calories: 400, protein: 20, cookingTime: "20 mins", ingredients: [{item: "whole wheat tortilla", quantity: 60, unit: "g"}, {item: "black beans", quantity: 100, unit: "g"}, {item: "scrambled tofu", quantity: 100, unit: "g"}, {item: "avocado", quantity: 50, unit: "g"}, {item: "salsa", quantity: 30, unit: "ml"}, {item: "vegan sausage patty", quantity: 50, unit: "g"}], instructions: 'Warm tortilla. Mash black beans. Cook scrambled tofu and vegan sausage patty. Assemble burrito with all fillings and salsa.' },
                    { name: "Vegan Pancakes with Fruit", calories: 380, protein: 10, cookingTime: "15 mins", ingredients: [{item: "vegan pancake mix", quantity: 80, unit: "g"}, {item: "plant milk", quantity: 100, unit: "ml"}, {item: "banana", quantity: 100, unit: "g"}, {item: "mixed berries", quantity: 80, unit: "g"}, {item: "maple syrup", quantity: 20, unit: "ml"}], instructions: 'Prepare pancake mix with plant milk. Cook pancakes. Top with sliced banana, mixed berries, and maple syrup.' }
                ],
                lunch: [
                    { name: "Buddha Bowl with Crispy Chickpeas", calories: 480, protein: 22, cookingTime: "30 mins", ingredients: [{item: "quinoa", quantity: 80, unit: "g"}, {item: "chickpeas", quantity: 100, unit: "g"}, {item: "roasted vegetables", quantity: 200, unit: "g"}, {item: "tahini dressing", quantity: 30, unit: "g"}, {item: "leafy greens", quantity: 80, unit: "g"}], instructions: 'Cook quinoa. Roast chickpeas and your favorite vegetables until crispy. Assemble bowl with leafy greens, cooked quinoa, roasted chickpeas and vegetables, and tahini dressing.' },
                    { name: "Hearty Lentil Soup", calories: 420, protein: 20, cookingTime: "30 mins", ingredients: [{item: "red lentils", quantity: 80, unit: "g"}, {item: "mixed vegetables", quantity: 200, unit: "g"}, {item: "vegetable broth", quantity: 300, unit: "ml"}, {item: "coconut milk", quantity: 50, unit: "ml"}, {item: "curry powder", quantity: 5, unit: "g"}, {item: "crushed tomatoes", quantity: 50, unit: "g"}], instructions: 'Sauté chopped vegetables. Add red lentils, vegetable broth, coconut milk, curry powder, and crushed tomatoes. Simmer until lentils are tender, about 20-25 minutes.' },
                    { name: "Mediterranean Quinoa Salad", calories: 410, protein: 18, cookingTime: "20 mins", ingredients: [{item: "quinoa", quantity: 70, unit: "g"}, {item: "cucumber", quantity: 80, unit: "g"}, {item: "cherry tomatoes", quantity: 80, unit: "g"}, {item: "olives", quantity: 30, unit: "g"}, {item: "red onion", quantity: 20, unit: "g"}, {item: "hummus", quantity: 50, unit: "g"}], instructions: 'Cook and cool quinoa. Chop cucumber, tomatoes, and red onion. Combine all ingredients with olives and a dollop of hummus. Dress with lemon juice and herbs.' },
                    { name: "Vegan Deli Slice Sandwich", calories: 390, protein: 15, cookingTime: "5 mins", ingredients: [{item: "whole grain bread", quantity: 100, unit: "g"}, {item: "vegan deli slices", quantity: 80, unit: "g"}, {item: "lettuce", quantity: 30, unit: "g"}, {item: "tomato", quantity: 50, unit: "g"}, {item: "vegan mayonnaise", quantity: 20, unit: "g"}], instructions: 'Assemble sandwich with bread, vegan deli slices, lettuce, tomato, and vegan mayonnaise.' },
                    { name: "Beyond Burger with Side Salad", calories: 600, protein: 25, cookingTime: "20 mins", ingredients: [{item: "beyond burger patty", quantity: 120, unit: "g"}, {item: "whole grain bun", quantity: 80, unit: "g"}, {item: "mixed greens", quantity: 100, unit: "g"}, {item: "dressing", quantity: 20, unit: "ml"}, {item: "onion", quantity: 20, unit: "g"}, {item: "tomato", quantity: 30, unit: "g"}], instructions: 'Cook Beyond Burger patty according to package. Toast bun. Assemble burger with desired toppings. Serve with a simple side salad.' }
                ],
                dinner: [
                    { name: "Creamy Lentil Curry", calories: 520, protein: 25, cookingTime: "30 mins", ingredients: [{item: "green lentils", quantity: 100, unit: "g"}, {item: "coconut milk", quantity: 150, unit: "ml"}, {item: "curry paste", quantity: 20, unit: "g"}, {item: "mixed vegetables", quantity: 250, unit: "g"}, {item: "brown rice", quantity: 80, unit: "g"}, {item: "spinach", quantity: 50, unit: "g"}], instructions: 'Cook brown rice. Sauté vegetables. Add green lentils, curry paste, coconut milk, and spinach. Simmer until lentils are tender and sauce has thickened. Serve with rice.' },
                    { name: "Spaghetti with Marinara & Meatballs", calories: 550, protein: 28, cookingTime: "35 mins", ingredients: [{item: "whole grain pasta", quantity: 100, unit: "g"}, {item: "vegan meatballs", quantity: 120, unit: "g"}, {item: "marinara sauce", quantity: 150, unit: "ml"}, {item: "onion", quantity: 30, unit: "g"}, {item: "garlic", quantity: 10, unit: "g"}, {item: "fresh basil", quantity: 10, unit: "g"}], instructions: 'Cook pasta. Sauté onion and garlic. Add vegan meatballs and cook until browned. Stir in marinara sauce and simmer. Serve over pasta, topped with fresh basil.' },
                    { name: "Sheet Pan Fajitas", calories: 480, protein: 20, cookingTime: "25 mins", ingredients: [{item: "bell peppers", quantity: 200, unit: "g"}, {item: "onion", quantity: 100, unit: "g"}, {item: "mushrooms", quantity: 100, unit: "g"}, {item: "black beans", quantity: 80, unit: "g"}, {item: "fajita seasoning", quantity: 10, unit: "g"}, {item: "tortillas", quantity: 60, unit: "g"}, {item: "avocado", quantity: 50, unit: "g"}], instructions: 'Toss sliced bell peppers, onion, and mushrooms with black beans and fajita seasoning on a sheet pan. Roast until tender. Serve in warm tortillas with sliced avocado.' },
                    { name: "Tofu Katsu Curry", calories: 600, protein: 30, cookingTime: "40 mins", ingredients: [{item: "firm tofu", quantity: 200, unit: "g"}, {item: "panko breadcrumbs", quantity: 50, unit: "g"}, {item: "flour", quantity: 20, unit: "g"}, {item: "curry block sauce", quantity: 100, unit: "g"}, {item: "jasmine rice", quantity: 80, unit: "g"}, {item: "broccoli", quantity: 100, unit: "g"}], instructions: 'Press tofu, coat in flour, then breadcrumbs. Fry until golden. Prepare curry sauce. Cook jasmine rice and steam broccoli. Serve tofu over rice with sauce and broccoli.' },
                    { name: "Chickpea & Spinach Masala", calories: 490, protein: 24, cookingTime: "30 mins", ingredients: [{item: "chickpeas", quantity: 150, unit: "g"}, {item: "spinach", quantity: 100, unit: "g"}, {item: "diced tomatoes", quantity: 150, unit: "g"}, {item: "onion", quantity: 50, unit: "g"}, {item: "garlic", quantity: 10, unit: "g"}, {item: "ginger", quantity: 5, unit: "g"}, {item: "garam masala", quantity: 5, unit: "g"}, {item: "brown rice", quantity: 70, unit: "g"}], instructions: 'Cook brown rice. Sauté onion, garlic, ginger. Add chickpeas, diced tomatoes, garam masala. Simmer. Stir in spinach until wilted. Serve with rice.' },
                    { name: "Impossible Burger with Sweet Potato Fries", calories: 650, protein: 27, cookingTime: "30 mins", ingredients: [{item: "impossible burger patty", quantity: 120, unit: "g"}, {item: "sweet potato", quantity: 200, unit: "g"}, {item: "whole grain bun", quantity: 80, unit: "g"}, {item: "ketchup", quantity: 20, unit: "g"}, {item: "lettuce", quantity: 20, unit: "g"}, {item: "tomato", quantity: 30, unit: "g"}], instructions: 'Cook Impossible Burger patty. Slice sweet potato into fries and bake. Assemble burger with bun, lettuce, tomato. Serve with fries and ketchup.' }
                ],
                snacks: [
                    { name: "Energy Balls", calories: 120, protein: 4, cookingTime: "10 mins", ingredients: [{item: "dates", quantity: 40, unit: "g"}, {item: "walnuts", quantity: 20, unit: "g"}, {item: "chia seeds", quantity: 5, unit: "g"}, {item: "cocoa powder", quantity: 5, unit: "g"}], instructions: 'Blend dates, walnuts, chia seeds, and cocoa powder in a food processor until a sticky mixture forms. Roll into small balls.' },
                    { name: "Hummus & Veggie Sticks", calories: 110, protein: 5, cookingTime: "5 mins", ingredients: [{item: "hummus", quantity: 50, unit: "g"}, {item: "carrots", quantity: 80, unit: "g"}, {item: "cucumber", quantity: 80, unit: "g"}, {item: "bell peppers", quantity: 80, unit: "g"}], instructions: 'Serve hummus with sliced carrots, cucumber sticks, and bell pepper strips for dipping.' },
                    { name: "Protein Smoothie", calories: 130, protein: 8, cookingTime: "5 mins", ingredients: [{item: "plant protein powder", quantity: 15, unit: "g"}, {item: "plant milk", quantity: 150, unit: "ml"}, {item: "banana", quantity: 100, unit: "g"}, {item: "spinach", quantity: 20, unit: "g"}], instructions: 'Blend plant protein powder, preferred plant milk, banana, and spinach until smooth.' },
                    { name: "Mixed Nuts & Dried Fruit", calories: 180, protein: 6, cookingTime: "1 min", ingredients: [{item: "mixed nuts", quantity: 30, unit: "g"}, {item: "dried fruit", quantity: 20, unit: "g"}], instructions: 'Combine mixed nuts and dried fruit for a quick snack.' },
                    { name: "Apple with Almond Butter", calories: 150, protein: 6, cookingTime: "5 mins", ingredients: [{item: "apple", quantity: 150, unit: "g"}, {item: "almond butter", quantity: 20, unit: "g"}, {item: "cinnamon", quantity: 2, unit: "g"}], instructions: 'Slice an apple and spread almond butter on the slices. Sprinkle with cinnamon.' },
                    { name: "Edamame (steamed)", calories: 160, protein: 14, cookingTime: "10 mins", ingredients: [{item: "frozen edamame", quantity: 150, unit: "g"}, {item: "salt", quantity: 2, unit: "g"}], instructions: 'Steam frozen edamame according to package instructions. Sprinkle with salt.' }
                ]
            };

            // Step 1: Filter based on allergies/exclusions (existing logic)
            const exclusions = Array.from(document.querySelectorAll('#foodExclusions input:checked')).map(cb => cb.value);
            console.log('Exclusions:', exclusions);
            let filteredByExclusions = {};
            Object.keys(meals).forEach(mealType => {
                filteredByExclusions[mealType] = meals[mealType].filter(meal => {
                    const mealIngredients = meal.ingredients.map(ing => ing.item.toLowerCase());
                    return !exclusions.some(ex => mealIngredients.some(ingItem => ingItem.includes(ex.toLowerCase())));
                });
            });

            // Step 2: Filter based on milk preference
            const milkPreference = userData.milkPreference; // 'any', 'almond', 'soy', 'oat', 'coconut'
            let filteredByMilk = {};
            if (milkPreference && milkPreference !== 'any') {
                Object.keys(filteredByExclusions).forEach(mealType => {
                    filteredByMilk[mealType] = filteredByExclusions[mealType].filter(meal => {
                        const mealIngredients = meal.ingredients.map(ing => ing.item.toLowerCase());
                        const milkIngredientsInMeal = mealIngredients.filter(ing => ing.includes('plant milk'));
                        
                        // If meal has no generic 'plant milk' entry, it's fine.
                        if (milkIngredientsInMeal.length === 0) {
                            return true;
                        }

                        // Check if the recipe explicitly uses a milk type or if it's a generic 'plant milk'
                        // If it's a specific milk, then it must match the preference.
                        const recipeUsesSpecificMilk = mealIngredients.some(ing => ['almond milk', 'soy milk', 'oat milk', 'coconut milk'].includes(ing));
                        
                        if (recipeUsesSpecificMilk) {
                            return mealIngredients.some(ing => ing.includes(milkPreference));
                        } else {
                            // If recipe uses generic "plant milk", it's compatible with any choice
                            return true;
                        }
                    });
                });
            } else {
                filteredByMilk = filteredByExclusions; // No specific milk preference, use all already filtered meals
            }

            // Step 3: Filter based on vegan substitute preference
            const substitutePreference = userData.substitutePreference; // 'none', 'some', 'all'
            let finalFilteredMeals = {};
            Object.keys(filteredByMilk).forEach(mealType => {
                finalFilteredMeals[mealType] = filteredByMilk[mealType].filter(meal => {
                    const mealNameLower = meal.name.toLowerCase();
                    const mealIngredients = meal.ingredients.map(ing => ing.item.toLowerCase());

                    const hasGenericSubstitute = mealNameLower.includes('vegan patty') || mealNameLower.includes('vegan sausage') ||
                                                 mealIngredients.some(ing => ing.includes('vegan patty') || ing.includes('vegan sausage'));
                    const hasBrandedSubstitute = mealNameLower.includes('beyond') || mealNameLower.includes('impossible') ||
                                                 mealIngredients.some(ing => ing.includes('beyond meat') || ing.includes('impossible meat'));

                    if (substitutePreference === 'none') {
                        // Exclude all substitutes
                        return !hasGenericSubstitute && !hasBrandedSubstitute;
                    } else if (substitutePreference === 'some') {
                        // Allow generic, exclude branded
                        return !hasBrandedSubstitute;
                    } else if (substitutePreference === 'all') {
                        // Allow all substitutes
                        return true;
                    }
                    return true; // Default if preference is not explicitly handled or for any other value
                });
            });

            console.log('Final Filtered Meals based on all preferences:', finalFilteredMeals);
            return finalFilteredMeals;
        }


        function generateWeeklyMealPlan(mealStructure, veganMeals) {
            console.log('--- generateWeeklyMealPlan() started ---');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const weekPlan = {};
            const mealChoiceMap = { 'low': 1, 'medium': Math.ceil(days.length / 2), 'high': days.length };
            const numUniqueMeals = mealChoiceMap[userData.variety] || days.length;
            console.log('Number of unique meals to select:', numUniqueMeals);

            const selectUniqueMeals = (arr, count) => {
                if (!arr || arr.length === 0) {
                    console.warn(`No meals available in array for selection. Returning empty array.`);
                    return [];
                }
                // Shuffle the array and pick 'count' unique meals
                const shuffled = arr.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, Math.min(count, shuffled.length));
                console.log(`Selected ${selected.length} unique meals from ${arr.length}:`, selected.map(m => m.name));
                return selected;
            };

            const selectedUniqueMeals = {
                breakfast: selectUniqueMeals(veganMeals.breakfast, numUniqueMeals),
                lunch: selectUniqueMeals(veganMeals.lunch, numUniqueMeals),
                dinner: selectUniqueMeals(veganMeals.dinner, numUniqueMeals),
                snacks: selectUniqueMeals(veganMeals.snacks, numUniqueMeals)
            };
            console.log('Selected Unique Meals for each type:', selectedUniqueMeals);

            // Populate the weekPlan with meals, cycling through the selected unique meals
            days.forEach((day, index) => {
                weekPlan[day] = {
                    breakfast: selectedUniqueMeals.breakfast[index % selectedUniqueMeals.breakfast.length],
                    lunch: selectedUniqueMeals.lunch[index % selectedUniqueMeals.lunch.length],
                    dinner: selectedUniqueMeals.dinner[index % selectedUniqueMeals.dinner.length],
                    snacks: selectedUniqueMeals.snacks[index % selectedUniqueMeals.snacks.length]
                };
            });
            console.log('--- generateWeeklyMealPlan() finished ---');
            return weekPlan;
        }
        
        function displayMealPlan() {
            console.log('--- displayMealPlan() started ---');
            const resultsDiv = document.getElementById('mealPlanResults');
            if (Object.keys(mealPlan).length === 0) {
                resultsDiv.innerHTML = '<p class="warning">Could not generate a meal plan based on your preferences. Please try adjusting your inputs.</p>';
                console.warn('Meal plan is empty, displaying warning.');
                return;
            }
            let html = '';
            Object.keys(mealPlan).forEach(weekKey => { // weekKey will be "Week 1", "Week 2", etc.
                html += `<h3 style="text-align: center; margin-top: 30px; margin-bottom: 20px; color: #5a67d8;">${weekKey}</h3>`;
                const weeklyPlan = mealPlan[weekKey];
                Object.keys(weeklyPlan).forEach(day => {
                    const dayMeals = weeklyPlan[day];
                    // Ensure all meal types exist before trying to access their properties
                    const totalCals = Object.values(dayMeals).reduce((sum, meal) => sum + (meal ? meal.calories : 0), 0);
                    html += `
                        <div class="day-card">
                            <div class="day-header">${day} - ${totalCals} calories</div>
                            <div class="meals">
                                <div class="meal"><div class="meal-type">🌅 Breakfast</div><div class="meal-item">${dayMeals.breakfast ? dayMeals.breakfast.name : 'N/A'} (${dayMeals.breakfast ? dayMeals.breakfast.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">🌞 Lunch</div><div class="meal-item">${dayMeals.lunch ? dayMeals.lunch.name : 'N/A'} (${dayMeals.lunch ? dayMeals.lunch.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">🌙 Dinner</div><div class="meal-item">${dayMeals.dinner ? dayMeals.dinner.name : 'N/A'} (${dayMeals.dinner ? dayMeals.dinner.calories : 0} cal)</div></div>
                                <div class="meal"><div class="meal-type">🍎 Snack</div><div class="meal-item">${dayMeals.snacks ? dayMeals.snacks.name : 'N/A'} (${dayMeals.snacks ? dayMeals.snacks.calories : 0} cal)</div></div>
                            </div>
                        </div>`;
                });
            });
            resultsDiv.innerHTML = html;
            console.log('--- displayMealPlan() finished ---');
        }

        function createShoppingList() {
            console.log('--- createShoppingList() started ---');
            const allIngredients = {};
            Object.values(mealPlan).forEach(weeklyPlan => { // Iterate over each week's plan
                Object.values(weeklyPlan).forEach(day => {
                    Object.values(day).forEach(meal => {
                        if (meal && meal.ingredients) { // Ensure meal and ingredients exist
                            meal.ingredients.forEach(ing => {
                                const key = ing.item.toLowerCase();
                                // Handle specific milk type replacement for shopping list based on user preference
                                let itemKey = key;
                                if (key === 'plant milk' && userData.milkPreference !== 'any') {
                                    itemKey = userData.milkPreference + ' milk';
                                }

                                if (!allIngredients[itemKey]) {
                                    allIngredients[itemKey] = { quantity: 0, unit: ing.unit };
                                }
                                allIngredients[itemKey].quantity += ing.quantity;
                                if(ing.unit === 'unit') allIngredients[itemKey].unit = 'units';
                            });
                        }
                    });
                });
            });
            console.log('All ingredients gathered:', allIngredients);

            const categories = {
                'Produce': ['banana', 'berries', 'spinach', 'avocado', 'tomato', 'lime', 'vegetables', 'leafy greens', 'bell peppers', 'carrots', 'cucumber', 'apple', 'sweet potato', 'cherry tomatoes', 'fresh fruit', 'alfalfa sprouts', 'fresh ginger', 'seasonal vegetables', 'lettuce', 'basil', 'onion', 'garlic', 'diced tomatoes'],
                'Pantry Staples': ['oats', 'chia seeds', 'maple syrup', 'quinoa', 'rice', 'bread', 'tortilla', 'pasta', 'dates', 'spices', 'herbs', 'vanilla extract', 'turmeric', 'curry powder', 'curry paste', 'cocoa powder', 'cinnamon', 'canned crushed tomatoes', 'flax seeds', 'salsa', 'curry block sauce', 'panko breadcrumbs', 'flour', 'garam masala'],
                'Plant Proteins': ['chickpeas', 'lentils', 'beans', 'tofu', 'plant protein powder', 'black bean patty', 'vegan sausage', 'vegan patty', 'beyond meat grounds', 'impossible burger patty', 'vegan deli slices', 'vegan meatballs', 'edamame'],
                'Nuts & Seeds': ['hemp seeds', 'nuts', 'almonds', 'walnuts', 'cashews', 'almond butter', 'tahini'],
                'Plant Milks & Alternatives': ['almond milk', 'coconut milk', 'nutritional yeast', 'cashew cream', 'soy milk', 'oat milk', 'plant milk'], // Keep 'plant milk' as fallback for categorization
                'Condiments & Sauces': ['hummus', 'soy sauce', 'tahini dressing', 'vegan mayonnaise', 'ketchup', 'marinara sauce', 'dressing'],
                'Frozen': ['frozen banana', 'frozen edamame'],
                'Other': ['granola', 'vegetable broth', 'corn', 'toast', 'bun', 'salt']
            };

            shoppingList = {}; // Clear shoppingList object before populating
            Object.keys(categories).forEach(cat => shoppingList[cat] = []);
            
            for (const [ingName, ingData] of Object.entries(allIngredients)) {
                let foundCategory = false;
                for (const [catName, catItems] of Object.entries(categories)) {
                    if (catItems.some(item => ingName.includes(item))) {
                        shoppingList[catName].push({ name: ingName, ...ingData });
                        foundCategory = true;
                        break;
                    }
                }
                if (!foundCategory) {
                    if (!shoppingList['Other']) shoppingList['Other'] = [];
                    shoppingList['Other'].push({ name: ingName, ...ingData });
                }
            }
            // Ensure no 'plant milk' item if a specific one was chosen
            if (userData.milkPreference !== 'any') {
                shoppingList['Plant Milks & Alternatives'] = shoppingList['Plant Milks & Alternatives'].filter(item => item.name !== 'plant milk');
            }
            console.log('--- createShoppingList() finished ---');
        }
        
        function createRecipeGuide() { // Removed parameter as recipes are now collected during meal plan generation
            console.log('--- createRecipeGuide() started ---');
            // Recipes object is already populated in createMealPlan loop
            // This function now just ensures recipes is ready for display/download
            if (Object.keys(recipes).length === 0) {
                console.warn('Recipes object is empty after meal plan generation.');
            }
            console.log('--- createRecipeGuide() finished ---');
        }
        
        function showShoppingList() {
            const resultsDiv = document.getElementById('shoppingListResults');
            let html = '<div class="shopping-list">';
            if (Object.keys(shoppingList).length === 0 || Object.values(shoppingList).every(arr => arr.length === 0)) {
                resultsDiv.innerHTML = '<p class="warning">No shopping list generated. Please ensure a meal plan was successfully created.</p>';
                return;
            }

            Object.entries(shoppingList).forEach(([category, items]) => {
                if (items.length > 0) {
                    html += `<div class="category-title">${category}</div><ul class="item-list">`;
                    items.forEach(item => {
                        html += `<li class="shopping-item">${formatShoppingListItem(item)}</li>`;
                    });
                    html += `</ul>`;
                }
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
            showStep(8); // This is step7
        }

        function showRecipes() {
            const resultsDiv = document.getElementById('recipeResults');
            let html = '<div class="recipe-section">';
            if (Object.keys(recipes).length === 0) {
                resultsDiv.innerHTML = '<p class="warning">No recipes generated. Please ensure a meal plan was successfully created.</p>';
                return;
            }
            const sortedRecipeNames = Object.keys(recipes).sort();
            sortedRecipeNames.forEach(recipeName => {
                const recipe = recipes[recipeName];
                html += `
                    <div class="recipe-card">
                        <div class="recipe-title">${recipeName}</div>
                        <div class="recipe-info">
                            <span>🔋 ${recipe.calories} cal</span>
                            <span>💪 ${recipe.protein}g protein</span>
                            <span>⏰ ${recipe.cookingTime}</span>
                        </div>
                        <h4>Ingredients:</h4>
                        <ul class="ingredients-list">${recipe.ingredients.map(ing => `<li>${ing.quantity}${ing.unit} ${ing.item}</li>`).join('')}</ul>
                        <h4>Instructions:</h4>
                        <ol class="instructions-list">${recipe.instructions.split('. ').filter(s => s.trim()).map(s => `<li>${s.trim()}${s.endsWith('.')?'':'.'}</li>`).join('')}</ol>
                    </div>`;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;

            showStep(9); // This is step8 (Recipes)
        }

        function showBenefits() { // New function to show the benefits section
            displayComparativeBenefits();
            showStep(10); // This is step9 (Benefits)
        }

        function showRecipesBack() { // Function to go back from benefits to recipes
            showStep(9); // Go back to the recipes step (step8)
        }

        function displayComparativeBenefits() {
            const benefitsSection = document.getElementById('comparativeBenefitsSection');
            // benefitsSection.classList.remove('hidden'); // No longer needed as it's within its own active step

            // --- Animal Lives Saved ---
            // Data sources vary, using widely cited averages for *one week* and *one year* of veganism vs. omnivore
            // These numbers are derived from various sources that aggregate FAO and national consumption data.
            // Example derivations often cite data like:
            // - Average US chicken consumption per capita: ~90-100 lbs/year -> several dozen chickens
            // - Average pig consumption -> fractional pig per year
            // - Average cattle consumption -> fractional cattle per year
            // - Average fish consumption -> hundreds of fish/shellfish per year.
            // Numbers here are representative based on common estimates.

            const chickensSavedWeek = (35 / 52) * userData.numWeeks; // Approx 35 chickens per omnivore per year
            const chickensSavedTotal = 35 * userData.numWeeks;
            const pigsSavedWeek = (0.7 / 52) * userData.numWeeks;    // Approx 0.7 pigs per omnivore per year
            const pigsSavedTotal = 0.7 * userData.numWeeks;
            const cowsSavedWeek = (0.15 / 52) * userData.numWeeks;   // Approx 0.15 cows per omnivore per year
            const cowsSavedTotal = 0.15 * userData.numWeeks;
            const fishSavedWeek = (150 / 52) * userData.numWeeks;    // Approx 150 fish per omnivore per year
            const fishSavedTotal = 150 * userData.numWeeks;

            let animalsSavedWeekText = `• 🐔 <strong>${chickensSavedWeek.toFixed(1)}</strong> chicken${chickensSavedWeek !== 1 ? 's' : ''}`;
            animalsSavedWeekText += `<br>• 🐷 <strong>${pigsSavedWeek.toFixed(2)}</strong> pig${pigsSavedWeek !== 1 ? 's' : ''}`;
            animalsSavedWeekText += `<br>• 🐄 <strong>${cowsSavedWeek.toFixed(2)}</strong> cow${cowsSavedWeek !== 1 ? 's' : ''}`;
            animalsSavedWeekText += `<br>• 🐟 <strong>${fishSavedWeek.toFixed(1)}</strong> fish`;
            document.getElementById('animalsSavedWeek').innerHTML = `<strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong><br>${animalsSavedWeekText}`;

            let animalsSavedYearText = `• 🐔 <strong>${chickensSavedTotal.toFixed(0)}</strong> chicken${chickensSavedTotal !== 1 ? 's' : ''}`;
            animalsSavedYearText += `<br>• 🐷 <strong>${pigsSavedTotal.toFixed(1)}</strong> pig${pigsSavedTotal !== 1 ? 's' : ''}`;
            animalsSavedYearText += `<br>• 🐄 <strong>${cowsSavedTotal.toFixed(1)}</strong> cow${cowsSavedTotal !== 1 ? 's' : ''}`;
            animalsSavedYearText += `<br>• 🐟 <strong>${fishSavedTotal.toFixed(0)}</strong> fish`;
            document.getElementById('animalsSavedYear').innerHTML = `<strong>Projected per year:</strong><br>${animalsSavedYearText}`;


            // --- Environmental Benefits Saved ---
            // Using approximate weekly and yearly savings for an average person switching to vegan
            // Per day (estimated averages for a shift from omnivore to vegan, based on scientific studies):
            // - Land: ~18 sq meters per day
            // - CO2e: ~1.8 kg CO2e per day (difference between ~2.5kg omnivore and ~0.7kg vegan)
            // - Water: ~4164 liters per day
            
            // Per Selected Weeks
            const landSavedSqMetersTotal = 18 * 7 * userData.numWeeks; 
            const landSavedSqFtTotal = (landSavedSqMetersTotal * 10.764).toFixed(0); 
            const co2SavedKgTotal = (2.5 - 0.7) * 7 * userData.numWeeks; 
            const co2SavedLbsTotal = (co2SavedKgTotal * 2.20462).toFixed(1);
            const waterSavedLitersTotal = 4164 * 7 * userData.numWeeks; 
            const waterSavedGallonsTotal = (waterSavedLitersTotal / 3.785).toFixed(0);

            // Per Year (re-calculate based on full year)
            const landSavedSqMetersYear = 18 * 365;
            const landSavedAcresYear = (landSavedSqMetersYear / 4046.86).toFixed(1); // 1 acre = 4046.86 sq meters
            const co2SavedTonnesYear = ((2.5 - 0.7) * 365 / 1000).toFixed(2); // Convert kg to tonnes
            const waterSavedMillionLitersYear = (4164 * 365 / 1000000).toFixed(2); // Convert liters to million liters

            document.getElementById('landSaved').innerHTML = `• 🌱 <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${landSavedSqFtTotal} square feet</strong> (${landSavedSqMetersTotal} square meters) of land. (Enough for a small garden!)<br>• 🌱 <strong>Projected per year:</strong> Approximately <strong>${landSavedAcresYear} acres</strong> of land.`;
            document.getElementById('co2Saved').innerHTML = `• 💨 <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${co2SavedKgTotal.toFixed(1)} kg CO2e</strong> (${co2SavedLbsTotal} lbs CO2e) of greenhouse gas emissions. (Equivalent to driving a car for ~${(co2SavedKgTotal / 0.22).toFixed(0)} km)<br>• 🌍 <strong>Projected per year:</strong> Approximately <strong>${co2SavedTonnesYear} tonnes CO2e</strong>.`;
            document.getElementById('waterSaved').innerHTML = `• 💧 <strong>Over ${userData.numWeeks} week${userData.numWeeks !== 1 ? 's' : ''}:</strong> Approximately <strong>${waterSavedLitersTotal} liters</strong> (${waterSavedGallonsTotal} gallons) of water. (Enough for ~${(waterSavedLitersTotal / 150).toFixed(0)} showers!)<br>• 🚿 <strong>Projected per year:</strong> Approximately <strong>${waterSavedMillionLitersYear} million liters</strong> of water.`;

            // Add sources section here by dynamically adding content to the benefitsSection
            // Check if sources section already exists to avoid duplication on multiple calls
            let existingSourcesDiv = benefitsSection.querySelector('.impact-sources');
            if (existingSourcesDiv) {
                existingSourcesDiv.remove(); // Remove existing to re-add fresh content
            }

            let sourcesHtml = `
                <h4>Sources for Impact Data</h4>
                <ul>
                    <li><strong>Animal Lives Saved:</strong> Estimates are derived from national and international agricultural statistics (e.g., USDA) combined with per capita consumption data. For general estimations and methodology, refer to organizations like The Vegan Society, which regularly updates these figures based on available data.
                        <ul>
                            <li><a href="https://www.vegansociety.com/go-vegan/why-go-vegan/animals" target="_blank">The Vegan Society: Why go vegan? (Animals)</a></li>
                        </ul>
                    </li>
                    <li>Poore, J., & Nemecek, T. (2018). Reducing food’s environmental impacts through producers and consumers. <a href="https://www.science.org/doi/10.1126/science.aaq0216" target="_blank"><em>Science</em>, 360(6392), 987-992.</a></li>
                    <li><a href="https://www.vegansociety.com/go-vegan/why-go-vegan/environment" target="_blank">The Vegan Society: Why go vegan? (Environment)</a> (Summarizes impact data)</li>
                </ul>
            `;
            const sourcesDiv = document.createElement('div');
            sourcesDiv.classList.add('impact-sources'); // Add a class for easier identification
            sourcesDiv.innerHTML = sourcesHtml;
            benefitsSection.appendChild(sourcesDiv);
        }

        function showMealPlan() {
            showStep(7); // This is step6
        }
        
        // --- PDF Generation Logic ---

        // Function to convert hex color to RGB array (no longer strictly needed for jsPDF direct calls but kept for consistency)
        function hexToRgb(hex) {
            var r = parseInt(hex.substring(1, 3), 16);
            var g = parseInt(hex.substring(3, 5), 16);
            var b = parseInt(hex.substring(5, 7), 16);
            return [r, g, b];
        }

        // Main PDF download function, kept for compatibility if needed elsewhere
        async function downloadPDF(contentElementId, filename) {
            const contentElement = document.getElementById(contentElementId);
            try {
                const canvas = await html2canvas(contentElement, {
                    scale: 2,
                    useCORS: true,
                    width: contentElement.scrollWidth,
                    height: contentElement.scrollHeight
                });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = pdfHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();

                while (heightLeft > 0) {
                    position -= pdf.internal.pageSize.getHeight();
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }
                pdf.save(filename);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Could not generate PDF. Please try again.');
            }
        }
        
        function downloadPlan() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageHeight = pdf.internal.pageSize.getHeight();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15; // Set margin to 15mm
            let cursorY = margin;

            if (Object.keys(mealPlan).length === 0) {
                alert('No meal plan data available to download. Please generate a meal plan first.');
                return;
            }

            pdf.setFont("helvetica");
            pdf.setFontSize(24);
            pdf.text("Your Multi-Week Vegan Meal Plan", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 20;

            const tableHeaders = ["Day", "Total Calories", "Meals"];
            const availableWidth = pageWidth - (2 * margin);
            const colWidths = [availableWidth * 0.18, availableWidth * 0.22, availableWidth * 0.60];
            const colStarts = [margin, margin + colWidths[0], margin + colWidths[0] + colWidths[1]];


            Object.keys(mealPlan).forEach(weekKey => {
                // Add Week Header
                pdf.addPage(); // Start each week on a new page for clarity in PDF
                cursorY = margin; // Reset Y for new page

                pdf.setFontSize(18); // Larger font for week title
                pdf.text(weekKey, pageWidth / 2, cursorY, { align: "center" });
                cursorY += 15;

                // Draw table headers for each week
                pdf.setFontSize(10);
                tableHeaders.forEach((header, index) => {
                    pdf.text(header, colStarts[index] + 2, cursorY + 5); 
                });
                cursorY += 8;

                const weeklyPlan = mealPlan[weekKey];
                Object.keys(weeklyPlan).forEach((day, dayIndex) => {
                    const dayMeals = weeklyPlan[day];
                    const totalCals = Object.values(dayMeals).reduce((sum, meal) => sum + (meal ? meal.calories : 0), 0);

                    const rowPadding = 2;
                    let maxCellHeight = 0;

                    const dayCellContent = day;
                    const calCellContent = `~${totalCals} kcal`;
                    
                    const mealsListFormatted = [
                        `Breakfast: ${dayMeals.breakfast ? dayMeals.breakfast.name : 'N/A'} (${dayMeals.breakfast ? dayMeals.breakfast.calories : 0} kcal)`,
                        `Lunch: ${dayMeals.lunch ? dayMeals.lunch.name : 'N/A'} (${dayMeals.lunch ? dayMeals.lunch.calories : 0} kcal)`,
                        `Dinner: ${dayMeals.dinner ? dayMeals.dinner.name : 'N/A'} (${dayMeals.dinner ? dayMeals.dinner.calories : 0} kcal)`,
                        `Snack: ${dayMeals.snacks ? dayMeals.snacks.name : 'N/A'} (${dayMeals.snacks ? dayMeals.snacks.calories : 0} kcal)`
                    ];
                    
                    let mealsLines = [];
                    mealsListFormatted.forEach(mealText => {
                        const lines = pdf.splitTextToSize(mealText, colWidths[2] - (2 * rowPadding)); 
                        mealsLines.push(...lines);
                    });
                    maxCellHeight = Math.max(maxCellHeight, mealsLines.length * 4.5);
                    maxCellHeight = Math.max(maxCellHeight, 15);

                    if (cursorY + maxCellHeight + rowPadding * 2 + margin > pageHeight) {
                        pdf.addPage();
                        cursorY = margin;
                        pdf.setFontSize(10);
                        tableHeaders.forEach((header, index) => {
                            pdf.text(header, colStarts[index] + 2, cursorY + 5);
                        });
                        cursorY += 8;
                    }

                    pdf.setLineWidth(0.2);

                    pdf.rect(colStarts[0], cursorY, colWidths[0], maxCellHeight + rowPadding * 2, 'S');
                    pdf.text(dayCellContent, colStarts[0] + rowPadding, cursorY + rowPadding + 3);

                    pdf.rect(colStarts[1], cursorY, colWidths[1], maxCellHeight + rowPadding * 2, 'S');
                    pdf.text(calCellContent, colStarts[1] + rowPadding, cursorY + rowPadding + 3);

                    pdf.rect(colStarts[2], cursorY, colWidths[2], maxCellHeight + rowPadding * 2, 'S');
                    let mealTextY = cursorY + rowPadding + 3;
                    mealsListFormatted.forEach(mealText => {
                        const lines = pdf.splitTextToSize(mealText, colWidths[2] - (2 * rowPadding));
                        lines.forEach(line => {
                            pdf.text(line, colStarts[2] + rowPadding, mealTextY);
                            mealTextY += 4.5;
                        });
                    });
                    cursorY += maxCellHeight + rowPadding * 2;
                });
            });

            pdf.save('vegan-meal-plan.pdf');
        }

        function formatShoppingListItem(item) {
            const { name, quantity, unit } = item;
            const capName = name.charAt(0).toUpperCase() + name.slice(1);
            if ((name.includes('milk') || name.includes('broth')) && unit === 'ml' && quantity >= 1000) {
                const liters = quantity / 1000;
                const cartons = Math.ceil(liters);
                if (liters === cartons) return `${capName} (${liters}L)`;
                return `${capName} (${cartons} x 1L carton${cartons > 1 ? 's' : ''}, ${quantity}ml total)`;
            }
            if (name.includes('avocado') && unit === 'g') {
                const count = Math.round(quantity / 150);
                return `${capName} (approx. ${count}, ${quantity}g total)`;
            }
            if (unit === 'units') return `${capName} (x${quantity})`;
            return `${capName} (${quantity}${unit})`;
        }
        
        function downloadShoppingList() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageHeight = pdf.internal.pageSize.getHeight();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15; // Set margin to 15mm
            let cursorY = margin;

            if (Object.keys(shoppingList).length === 0 || Object.values(shoppingList).every(arr => arr.length === 0)) {
                alert('No shopping list data available to download. Please generate a meal plan first.');
                return;
            }

            pdf.setFont("helvetica");
            pdf.setFontSize(24);
            pdf.text("Your Shopping List", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 20;

            const columnCount = 2;
            const columnGap = 10; // Gap between columns
            const availableWidthForColumns = pageWidth - (2 * margin) - ((columnCount - 1) * columnGap);
            const columnWidth = availableWidthForColumns / columnCount;

            // Track Y position for each column independently
            let columnYs = Array(columnCount).fill(cursorY);

            const sortedCategories = Object.keys(shoppingList).sort();

            sortedCategories.forEach(category => {
                const items = shoppingList[category];
                if (items.length === 0) return; // Skip empty categories

                pdf.setFontSize(12);
                const categoryTitleHeight = 7;
                const itemLineHeight = 5;
                const sectionPadding = 3; // Padding for category title and spacing between items

                // Calculate which column has less content (is "shorter") to add the next category
                let targetColumnIndex = 0;
                if (columnYs[1] < columnYs[0]) {
                    targetColumnIndex = 1;
                }

                let currentX = margin + (targetColumnIndex * (columnWidth + columnGap));
                let currentY = columnYs[targetColumnIndex];

                // Estimate height of the current category block to check if it fits
                let estimatedItemLines = 0;
                items.forEach(item => {
                    estimatedItemLines += pdf.splitTextToSize(`☐ ${formatShoppingListItem(item)}`, columnWidth - (2 * sectionPadding)).length;
                });
                const estimatedBlockHeight = categoryTitleHeight + sectionPadding + (estimatedItemLines * itemLineHeight) + sectionPadding;


                // If the block won't fit in the current column, try the other column first
                if (currentY + estimatedBlockHeight + margin > pageHeight) {
                    let otherColumnIndex = (targetColumnIndex === 0) ? 1 : 0;
                    if (columnYs[otherColumnIndex] + estimatedBlockHeight + margin > pageHeight) {
                        // If it doesn't fit in either column, add a new page
                        pdf.addPage();
                        columnYs = Array(columnCount).fill(margin); // Reset Y for both columns
                        currentY = margin;
                        pdf.setFontSize(24);
                        pdf.text("Your Shopping List (cont.)", pageWidth / 2, currentY, { align: "center" });
                        currentY += 20;
                        pdf.setFontSize(12);
                        columnYs = [currentY, currentY]; // Update base Y for new page
                        
                        targetColumnIndex = 0; // Always start new page from left column
                        currentX = margin;
                    } else {
                        // Fits in the other column, switch to it
                        targetColumnIndex = otherColumnIndex;
                        currentX = margin + (targetColumnIndex * (columnWidth + columnGap));
                        currentY = columnYs[targetColumnIndex]; // Set Y to the top of the next column
                        
                        pdf.setFontSize(12); // Redraw category title on new column
                        pdf.text(category + " (cont.)", currentX + sectionPadding, currentY + categoryTitleHeight / 2 + 1.5);
                        currentY += categoryTitleHeight + sectionPadding;
                        pdf.setFontSize(10);
                    }
                }
                
                // Draw category title
                pdf.text(category, currentX + sectionPadding, currentY + categoryTitleHeight / 2 + 1.5); // Center text vertically in title area
                currentY += categoryTitleHeight + sectionPadding;

                pdf.setFontSize(10);

                // Add items
                items.forEach(item => {
                    const itemText = `☐ ${formatShoppingListItem(item)}`;
                    const lines = pdf.splitTextToSize(itemText, columnWidth - (2 * sectionPadding)); // Use correct column width for wrapping
                    
                    lines.forEach(line => {
                        // Check if individual line fits. If not, manage page/column break.
                        if (currentY + itemLineHeight + margin > pageHeight) {
                            let nextColumnIndex = (targetColumnIndex === 0) ? 1 : 0;
                            if (columnYs[nextColumnIndex] + itemLineHeight + margin > pageHeight) {
                                // Neither column can fit, new page needed
                                pdf.addPage();
                                columnYs = Array(columnCount).fill(margin);
                                currentY = margin;
                                pdf.setFontSize(24);
                                pdf.text("Your Shopping List (cont.)", pageWidth / 2, currentY, { align: "center" });
                                currentY += 20;
                                pdf.setFontSize(12);
                                pdf.text(category + " (cont.)", margin + sectionPadding, currentY + categoryTitleHeight / 2 + 1.5);
                                currentY += categoryTitleHeight + sectionPadding;
                                pdf.setFontSize(10);
                                
                                targetColumnIndex = 0; // Start fresh on left column of new page
                                currentX = margin;
                            } else {
                                // Move to the other column on the current page
                                targetColumnIndex = nextColumnIndex;
                                currentX = margin + (targetColumnIndex * (columnWidth + columnGap));
                                currentY = columnYs[targetColumnIndex]; // Set Y to the top of the next column
                                
                                pdf.setFontSize(12); // Redraw category title on new column
                                pdf.text(category + " (cont.)", currentX + sectionPadding, currentY + categoryTitleHeight / 2 + 1.5);
                                currentY += categoryTitleHeight + sectionPadding;
                                pdf.setFontSize(10);
                            }
                        }
                        pdf.text(line, currentX + sectionPadding, currentY + itemLineHeight / 2); // Center text vertically in item line
                        currentY += itemLineHeight;
                    });
                });
                currentY += sectionPadding; // Space after each category

                columnYs[targetColumnIndex] = currentY; // Update the Y position for the column that was just used
            });

            pdf.save('vegan-shopping-list.pdf');
        }

        async function downloadRecipes() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageHeight = pdf.internal.pageSize.getHeight();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15;
            let cursorY = margin;

            if (Object.keys(recipes).length === 0) {
                alert('No recipe data available to download. Please generate a meal plan first.');
                return;
            }

            pdf.setFont("helvetica");
            pdf.setFontSize(24);
            pdf.text("Your Recipe Guide", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 20;

            pdf.setFontSize(10);

            // Ensure recipes are collected before calling this.
            // If createRecipeGuide() logic is now integrated into createMealPlan(), this might not be strictly necessary here.
            // For now, it relies on the global 'recipes' object being correctly populated.
            // createRecipeGuide(); // Call to ensure 'recipes' is up-to-date, if not done elsewhere

            const sortedRecipeNames = Object.keys(recipes).sort();

            for (let i = 0; i < sortedRecipeNames.length; i++) {
                const recipeName = sortedRecipeNames[i];
                const recipe = recipes[recipeName];

                const titleHeight = 8;
                const infoLineHeight = 5;
                const subtitleHeight = 7;
                const listItemHeight = 5.5; // Increased line height for list items
                const sectionSpacing = 4; // Increased space between sub-sections
                const cardPadding = 7; // Internal padding of the card

                // Calculate content width for text wrapping inside the card
                let currentContentWidth = pageWidth - (2 * margin) - (2 * cardPadding);
                
                const ingredientsLines = recipe.ingredients.reduce((acc, ing) => {
                    // Adjusted width for indentation
                    return acc + pdf.splitTextToSize(`• ${ing.quantity}${ing.unit} ${ing.item}`, currentContentWidth - 8).length; 
                }, 0);
                
                const instructionsSplit = recipe.instructions.split('. ').filter(s => s.trim());
                const instructionsLines = instructionsSplit.reduce((acc, inst, instIndex) => {
                    // Adjusted width for indentation
                    return acc + pdf.splitTextToSize(`${instIndex + 1}. ${inst.trim()}`, currentContentWidth - 8).length; 
                }, 0);

                const estimatedRecipeContentHeight = titleHeight + infoLineHeight + sectionSpacing +
                                                     subtitleHeight + (ingredientsLines * listItemHeight) + sectionSpacing +
                                                     subtitleHeight + (instructionsLines * listItemHeight);
                
                // Total estimated height for the card including its internal padding and spacing
                const estimatedRecipeCardHeight = estimatedRecipeContentHeight + (2 * cardPadding) + 10; // Extra buffer

                // Check if current recipe fits on the remaining part of the page
                if (cursorY + estimatedRecipeCardHeight + margin > pageHeight && i !== 0) {
                    pdf.addPage();
                    cursorY = margin;
                    pdf.setFontSize(24);
                    pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                    cursorY += 20;
                    pdf.setFontSize(10);
                }
                
                const x = margin;
                const width = pageWidth - (2 * margin);
                const cardStartY = cursorY;

                // Set default stroke color for rect (black) and line width
                pdf.setLineWidth(0.5); 

                // Add internal padding for content inside the card
                let contentX = x + cardPadding;
                let contentY = cursorY + cardPadding;

                // Add Recipe Title
                pdf.setFontSize(16);
                pdf.text(recipeName, contentX, contentY);
                contentY += titleHeight;

                // Add Recipe Info
                pdf.setFontSize(10);
                pdf.text(`Calories: ${recipe.calories} cal   Protein: ${recipe.protein}g   Time: ${recipe.cookingTime}`, contentX, contentY);
                contentY += infoLineHeight + sectionSpacing;

                // Add Ingredients
                pdf.setFontSize(12);
                pdf.text("Ingredients:", contentX, contentY);
                contentY += subtitleHeight;

                pdf.setFontSize(10);
                recipe.ingredients.forEach(ing => {
                    const ingredientText = `• ${ing.quantity}${ing.unit} ${ing.item}`;
                    const lines = pdf.splitTextToSize(ingredientText, currentContentWidth - 8);
                    lines.forEach(line => {
                        if (contentY + listItemHeight + margin > pageHeight) {
                            pdf.addPage();
                            cursorY = margin;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(24);
                            pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                            cursorY += 20;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(10);
                        }
                        pdf.text(line, contentX + 8, contentY);
                        contentY += listItemHeight;
                    });
                });
                contentY += sectionSpacing;

                // Add Instructions
                pdf.setFontSize(12);
                pdf.text("Instructions:", contentX, contentY);
                contentY += subtitleHeight;

                pdf.setFontSize(10);
                const instructions = recipe.instructions.split('. ').filter(s => s.trim());
                instructions.forEach((instruction, instIndex) => {
                    const instructionText = `${instIndex + 1}. ${instruction.trim()}${instruction.endsWith('.') ? '' : '.'}`;
                    const lines = pdf.splitTextToSize(instructionText, currentContentWidth - 8);
                    lines.forEach(line => {
                        if (contentY + listItemHeight + margin > pageHeight) {
                            pdf.addPage();
                            cursorY = margin;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(24);
                            pdf.text("Your Recipe Guide (cont.)", pageWidth / 2, cursorY, { align: "center" });
                            cursorY += 20;
                            contentY = cursorY + cardPadding;
                            pdf.setFontSize(10);
                        }
                        pdf.text(line, contentX + 8, contentY);
                        contentY += listItemHeight;
                    });
                });
                contentY += sectionSpacing + 5;
                
                // Calculate the actual height of the card content for border drawing
                const cardActualHeight = contentY - cardStartY;
                
                // Draw the rounded rectangle for the card after all content is placed
                pdf.roundedRect(x, cardStartY, width, cardActualHeight, 2, 2, 'S'); // 'S' for stroke (border only)
                
                cursorY = contentY; // Update main cursorY for the next recipe
            }
            pdf.save('vegan-recipes.pdf');
        }

        function restart() {
            currentStep = 1;
            userData = {};
            nutritionPlan = {};
            mealPlan = {};
            shoppingList = {};
            recipes = {};
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if(el.type === 'checkbox') el.checked = false;
                else el.value = '';
            });
            showStep(1);
        }

        function openInfoModal() {
            document.getElementById('infoModal').classList.remove('hidden');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        function openAdvantagesModal() {
            document.getElementById('advantagesModal').classList.remove('hidden');
        }

        function closeAdvantagesModal() {
            document.getElementById('advantagesModal').classList.add('hidden');
        }

        function openB12Modal() {
            document.getElementById('b12Modal').classList.remove('hidden');
        }

        function closeB12Modal() {
            document.getElementById('b12Modal').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            showStep(1);
            document.getElementById('bodyFat').addEventListener('change', toggleWeightLossRate);
        });
    </script>
</body>
</html>